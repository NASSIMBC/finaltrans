<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <title>Tizi Transport</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.95);
            --accent: #d4fb79;
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --border: rgba(255,255,255,0.1);
        }

        body { margin: 0; font-family: 'Urbanist', sans-serif; background: black; overflow: hidden; }
        
        #map { height: 100vh; width: 100%; z-index: 1; }
        .leaflet-control-attribution { display: none; }

        .top-bar { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; pointer-events: none; }
        .profile-chip { pointer-events: auto; background: var(--card-bg); backdrop-filter: blur(10px); padding: 8px 16px 8px 8px; border-radius: 50px; display: flex; align-items: center; gap: 10px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .profile-img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--accent); }
        .profile-text { font-size: 0.9rem; color: white; font-weight: 700; }
        .search-btn-top { pointer-events: auto; width: 45px; height: 45px; background: var(--card-bg); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid var(--border); cursor: pointer; color: white; backdrop-filter: blur(10px); }

        .search-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 2000; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .search-overlay.active { transform: translateY(0); }
        .search-card { background: var(--card-bg); padding: 25px; border-radius: 25px; border: 1px solid var(--border); width: 100%; max-width: 400px; margin: 50px auto 0 auto; box-sizing: border-box; }
        .card-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .btn-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

        .route-visual { display: flex; gap: 15px; }
        .dots-col { display: flex; flex-direction: column; align-items: center; padding-top: 15px; }
        .dot-start { width: 12px; height: 12px; background: var(--accent); border-radius: 50%; }
        .line { width: 2px; height: 50px; background: var(--text-muted); opacity: 0.3; margin: 5px 0; }
        .dot-end { width: 12px; height: 12px; border: 2px solid #ef4444; border-radius: 50%; }
        
        .inputs-col { flex: 1; display: flex; flex-direction: column; gap: 15px; position: relative; } /* Added relative for suggestions */
        .input-field { width: 100%; padding: 16px; border-radius: 12px; border: none; background: #0f172a; color: white; font-weight: 600; border: 1px solid var(--border); font-family: 'Urbanist', sans-serif; outline: none; box-sizing: border-box; }
        
        /* --- STYLE DES SUGGESTIONS --- */
        .suggestions-list {
            position: absolute; left: 0; right: 0; z-index: 100;
            background: #1e293b; border: 1px solid var(--border);
            border-radius: 12px; max-height: 200px; overflow-y: auto;
            margin-top: 5px; display: none; /* Caché par défaut */
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .suggestions-list.active { display: block; }
        .suggestion-item {
            padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer; font-size: 0.9rem; color: #cbd5e1; transition: 0.2s;
        }
        .suggestion-item:hover { background: rgba(212, 251, 121, 0.1); color: var(--accent); }
        .suggestion-item strong { color: white; }

        /* BOUTON VISIBILITÉ */
        .visibility-toggle {
            display: flex; align-items: center; justify-content: space-between;
            margin-top: 20px; background: rgba(255,255,255,0.05);
            padding: 12px 15px; border-radius: 12px; cursor: pointer; border: 1px solid transparent;
            transition: 0.3s;
        }
        .visibility-toggle.active { background: rgba(212, 251, 121, 0.1); border-color: var(--accent); }
        .vis-label { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; font-weight: 600; color: #cbd5e1; }
        .vis-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        .visibility-toggle.active .vis-icon { color: var(--accent); }
        
        .btn-main { width: 100%; padding: 16px; border-radius: 12px; border: none; background: var(--accent); color: black; font-size: 1rem; font-weight: 800; cursor: pointer; margin-top: 25px; }

        .bottom-sheet { position: absolute; bottom: 20px; left: 15px; right: 15px; background: var(--card-bg); backdrop-filter: blur(20px); border-radius: 24px; padding: 0 20px 20px 20px; z-index: 1500; border: 1px solid var(--border); transform: translateY(150%); transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1); max-height: 50vh; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-header { position: sticky; top: 0; background: inherit; z-index: 10; padding-top: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .drag-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 10px; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); }
        .sheet-title { font-weight: 800; color: var(--text-muted); font-size: 0.8rem; letter-spacing: 1px; }
        .btn-close-sheet { background: rgba(255,255,255,0.1); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; }

        .bus-item { display: flex; align-items: center; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 16px; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .bus-item:active { background: rgba(212, 251, 121, 0.1); border-color: var(--accent); }
        .bus-info { flex: 1; margin-left: 15px; }
        .bus-name { color: white; font-weight: 800; font-size: 1rem; }
        .bus-meta { color: var(--accent); font-size: 0.85rem; font-weight: 600; }
        .bus-matricule { background: rgba(212, 251, 121, 0.15); padding: 2px 6px; border-radius: 4px; color: var(--accent); font-size: 0.75rem; margin-left: 5px; }
        .bus-distance { color: white; font-weight: 700; }
    </style>
</head>
<body>

    <script>if(!localStorage.getItem('user_session')) window.location.href = '/connexion';</script>

    <div class="top-bar">
        <div class="profile-chip">
            <img src="https://ui-avatars.com/api/?name=User&background=random" class="profile-img">
            <div class="profile-text" id="txtName">Voyageur</div>
        </div>
        <div class="search-btn-top" onclick="toggleSearch()">
            <i class="fas fa-search"></i>
        </div>
    </div>

    <div id="map"></div>

    <div class="search-overlay active" id="searchOverlay">
        <div class="search-card">
            <div class="card-title">
                Trajet
                <button class="btn-close" onclick="toggleSearch()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="route-visual">
                <div class="dots-col"><div class="dot-start"></div><div class="line"></div><div class="dot-end"></div></div>
                <div class="inputs-col">
                    <div style="position:relative;">
                        <input type="text" class="input-field" id="txtDepart" placeholder="D'où partez-vous ? (ex: Tizi)">
                        <div id="listDepart" class="suggestions-list"></div>
                    </div>
                    
                    <div style="position:relative;">
                        <input type="text" class="input-field" id="txtArrivee" placeholder="Où allez-vous ? (ex: Alger)">
                        <div id="listArrivee" class="suggestions-list"></div>
                    </div>
                </div>
            </div>

            <div class="visibility-toggle active" id="btnVisibilite" onclick="toggleVisibility()">
                <div class="vis-label">
                    <div class="vis-icon"><i class="fas fa-eye" id="visIcon"></i></div>
                    <span id="visText">Visible par le chauffeur</span>
                </div>
                <i class="fas fa-toggle-on" id="visToggleIcon" style="font-size:1.5rem; color:var(--accent);"></i>
            </div>

            <button class="btn-main" onclick="lancerRecherche()">
                Trouver un chauffeur
            </button>
        </div>
    </div>

    <div class="bottom-sheet" id="resultsSheet">
        <div class="sheet-header">
            <div class="drag-handle"></div>
            <div class="sheet-title">RÉSULTATS</div>
            <button class="btn-close-sheet" onclick="fermerResultats()"><i class="fas fa-times"></i></button>
        </div>
        <div id="busList"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        const SERVER_URL = "https://finaltrans.onrender.com"; 
        let rechercheActive = false;
        let currentRouteLayer = null; 
        
        let isVisibleToDriver = true;
        let userLat, userLon, userMarker;
        let userSpeed = 0;
        let busMarkers = {};

        const session = JSON.parse(localStorage.getItem('user_session'));
        if(session && session.user.nom_complet) document.getElementById('txtName').innerText = session.user.nom_complet.split(' ')[0];

        const map = L.map('map', { zoomControl: false }).setView([36.72, 4.05], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const iconBus = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/5030/5030991.png', iconSize: [40, 40], iconAnchor: [20, 20] });
        const iconUser = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/5582/5582962.png', iconSize: [30, 30], iconAnchor: [15, 15] });

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                userSpeed = pos.coords.speed || 0;
                
                if(!userMarker) {
                    userMarker = L.marker([userLat, userLon], {icon: iconUser}).addTo(map);
                    map.setView([userLat, userLon], 14);
                } else {
                    userMarker.setLatLng([userLat, userLon]);
                }
                if(rechercheActive) fetchBus();
            }, err => console.log(err), { enableHighAccuracy: true });
        }

        // --- AUTOCOMPLÉTION ---
        function setupAutocomplete(inputId, listId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            let timeout = null;

            input.addEventListener('input', function() {
                const query = this.value;
                if(timeout) clearTimeout(timeout);
                
                if(query.length < 2) {
                    list.classList.remove('active');
                    return;
                }

                // Délai pour éviter trop d'appels API
                timeout = setTimeout(async () => {
                    try {
                        // API OpenStreetMap restreinte à l'Algérie (dz)
                        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=dz&addressdetails=1&limit=5`;
                        const res = await fetch(url);
                        const data = await res.json();

                        list.innerHTML = '';
                        if(data.length > 0) {
                            list.classList.add('active');
                            data.forEach(item => {
                                // On essaie de trouver le nom propre (Ville, Village, Commune)
                                const name = item.name;
                                const details = item.address.state || item.address.county || "Algérie";
                                
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.innerHTML = `<strong>${name}</strong> <span style="font-size:0.8rem; color:#64748b;">(${details})</span>`;
                                div.onclick = () => {
                                    input.value = name; // On met juste le nom
                                    list.classList.remove('active');
                                };
                                list.appendChild(div);
                            });
                        } else {
                            list.classList.remove('active');
                        }
                    } catch(e) { console.error("Erreur autocomplete", e); }
                }, 300);
            });

            // Cacher la liste si on clique ailleurs
            document.addEventListener('click', (e) => {
                if(e.target !== input && e.target !== list) {
                    list.classList.remove('active');
                }
            });
        }

        // Initialisation de l'autocomplétion sur les 2 champs
        setupAutocomplete('txtDepart', 'listDepart');
        setupAutocomplete('txtArrivee', 'listArrivee');


        // --- GESTION VISIBILITE ---
        function toggleVisibility() {
            isVisibleToDriver = !isVisibleToDriver;
            const btn = document.getElementById('btnVisibilite');
            const icon = document.getElementById('visIcon');
            const toggle = document.getElementById('visToggleIcon');
            const text = document.getElementById('visText');

            if(isVisibleToDriver) {
                btn.classList.add('active');
                icon.className = "fas fa-eye";
                toggle.className = "fas fa-toggle-on";
                toggle.style.color = "var(--accent)";
                text.innerText = "Visible par le chauffeur";
            } else {
                btn.classList.remove('active');
                icon.className = "fas fa-eye-slash";
                toggle.className = "fas fa-toggle-off";
                toggle.style.color = "#64748b";
                text.innerText = "Invisible pour le chauffeur";
            }
        }

        function toggleSearch() { document.getElementById('searchOverlay').classList.toggle('active'); }
        function fermerResultats() { document.getElementById('resultsSheet').classList.remove('active'); }

        function lancerRecherche() {
            const dep = document.getElementById('txtDepart').value;
            const arr = document.getElementById('txtArrivee').value;
            
            if (currentRouteLayer) { map.removeLayer(currentRouteLayer); currentRouteLayer = null; }
            document.querySelectorAll('.leaflet-marker-icon .terminus-flag').forEach(el => el.parentElement.remove());

            if(!dep && !arr) return alert("Remplissez au moins une ville !");

            rechercheActive = true;
            document.getElementById('searchOverlay').classList.remove('active');
            document.getElementById('resultsSheet').classList.add('active');
            document.getElementById('busList').innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">Recherche...</div>';
            
            fetchBus();
        }

        async function afficherTrajet(bus) {
            if (!bus.terminus_officiel) return;
            if (currentRouteLayer) { map.removeLayer(currentRouteLayer); currentRouteLayer = null; }

            const start = `${bus.current_lon},${bus.current_lat}`;
            const end = `${bus.terminus_officiel.lon},${bus.terminus_officiel.lat}`;
            const url = `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=full&geometries=geojson`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.routes && data.routes.length > 0) {
                    currentRouteLayer = L.geoJSON(data.routes[0].geometry, { style: { color: "#d4fb79", weight: 6, opacity: 0.9 } }).addTo(map);
                    map.fitBounds(currentRouteLayer.getBounds(), { padding: [50, 50] });
                }
            } catch (e) { console.error("Erreur trajet:", e); }
        }

        async function fetchBus() {
            if(!rechercheActive) return;
            const container = document.getElementById('busList');
            const dep = document.getElementById('txtDepart').value;
            const arr = document.getElementById('txtArrivee').value;

            let speedKmH = (userSpeed || 0) * 3.6;
            let effectiveVisibility = isVisibleToDriver;
            if (speedKmH > 15) { effectiveVisibility = false; }

            try {
                const res = await fetch(SERVER_URL + '/api/trouver-bus', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        user_lat: userLat, 
                        user_lon: userLon, 
                        depart_text: dep, 
                        arrivee_text: arr,
                        visible: effectiveVisibility 
                    })
                });
                const data = await res.json();
                
                container.innerHTML = '';
                for(let id in busMarkers) map.removeLayer(busMarkers[id]);
                busMarkers = {};

                if(data.bus_proches && data.bus_proches.length > 0) {
                    data.bus_proches.forEach(bus => {
                        const m = L.marker([bus.current_lat, bus.current_lon], {icon: iconBus}).addTo(map);
                        m.bindPopup(`
                            <div style="text-align:center; color:black;">
                                <strong>${bus.chauffeur}</strong><br>
                                <span style="font-size:0.8rem;">${bus.modele}</span><br>
                                <span style="background:#facc15; padding:2px; font-weight:bold;">${bus.matricule}</span>
                            </div>
                        `);
                        m.on('click', () => { afficherTrajet(bus); });
                        busMarkers[bus.bus_id] = m;

                        const div = document.createElement('div');
                        div.className = 'bus-item';
                        div.innerHTML = `
                            <div style="background:#333; width:40px; height:40px; border-radius:10px; display:flex; justify-content:center; align-items:center;">
                                <i class="fas fa-bus" style="color:white;"></i>
                            </div>
                            <div class="bus-info">
                                <div class="bus-name">${bus.chauffeur}</div>
                                <div class="bus-meta">${bus.modele} • <span class="bus-matricule">${bus.matricule}</span></div>
                                <div class="bus-sub">${bus.distance_km} km</div>
                            </div>
                            <div class="bus-dist"><i class="fas fa-chevron-right"></i></div>
                        `;
                        div.onclick = () => { 
                            afficherTrajet(bus); 
                            map.setView([bus.current_lat, bus.current_lon], 16); 
                            m.openPopup(); 
                        };
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Aucun bus trouvé.</div>';
                }
            } catch(e) { console.error(e); }
        }

        setInterval(fetchBus, 5000);
    </script>
</body>
</html>
