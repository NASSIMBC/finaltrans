<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <title>Shuttl</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #000000;
            --glass-bg: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary: #3b82f6;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --danger: #ef4444;
            --success: #10b981;
            --gold: #f59e0b;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); overflow: hidden; color: var(--text-main); }
        #map { height: 100vh; width: 100%; z-index: 1; background: #111; }
        .leaflet-control-attribution { display: none; }

        @keyframes float { 0% {transform: translateY(0px);} 50% {transform: translateY(-5px);} 100% {transform: translateY(0px);} }
        @keyframes pulse-glow { 0% {box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(6, 182, 212, 0);} 100% {box-shadow: 0 0 0 0 rgba(6, 182, 212, 0);} }
        
        .modern-bus-icon { background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 12px; color: white; display: flex; justify-content: center; align-items: center; font-size: 1.1rem; box-shadow: 0 0 20px rgba(59, 130, 246, 0.6); border: 2px solid rgba(255,255,255,0.8); transition: transform 0.3s; z-index: 1000 !important; }
        .modern-user-icon { background: var(--accent); border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px var(--accent); }
        .pulse-ring { border: 2px solid var(--accent); border-radius: 50%; height: 50px; width: 50px; position: absolute; left: -13px; top: -13px; animation: pulse-glow 2s infinite; opacity: 0; }
        .station-icon { background: #262626; border: 2px solid #525252; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        .top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; pointer-events: none; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        .profile-chip { pointer-events: auto; background: var(--glass-bg); backdrop-filter: blur(12px); padding: 6px 16px 6px 6px; border-radius: 50px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--glass-border); box-shadow: var(--shadow); }
        .profile-img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--accent); }
        .profile-text { font-size: 0.95rem; color: var(--text-main); font-weight: 700; letter-spacing: 0.5px; }
        
        .top-right-group { display: flex; gap: 12px; pointer-events: auto; }
        .round-btn { width: 48px; height: 48px; background: var(--glass-bg); backdrop-filter: blur(12px); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid var(--glass-border); cursor: pointer; color: var(--text-main); transition: 0.3s; box-shadow: var(--shadow); position: relative; }
        .round-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.1); }
        .notif-badge { position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: var(--danger); border-radius: 50%; border: 2px solid black; display:none; }

        .news-modal { position: absolute; bottom: 0; left: 0; width: 100%; height: 90vh; background: #111; border-radius: 30px 30px 0 0; z-index: 2500; transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; box-sizing: border-box; padding: 25px; border-top: 1px solid var(--glass-border); }
        .news-modal.active { transform: translateY(0); }
        .news-content { overflow-y: auto; flex: 1; padding-bottom: 50px; }
        .news-item { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--glass-border); transition: 0.2s; cursor: pointer; }
        .news-item:active { background: rgba(255,255,255,0.1); }
        .news-source { font-size: 0.75rem; color: var(--accent); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display:flex; justify-content:space-between;}
        .news-title { font-size: 1rem; font-weight: 700; line-height: 1.4; margin-bottom: 8px; color: white; }
        .news-summary { font-size: 0.85rem; color: var(--text-muted); line-height: 1.4; }
        .news-date { color: var(--text-muted); font-weight: 400; }

        .search-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: auto; z-index: 2000; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; pointer-events: none; }
        .search-card { pointer-events: auto; background: rgba(15, 15, 20, 0.85); backdrop-filter: blur(20px); padding: 25px; border-radius: 30px; border: 1px solid var(--glass-border); width: 100%; max-width: 450px; margin: 0 auto; box-sizing: border-box; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .search-card.active { transform: translateY(0); }
        .card-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; letter-spacing: 1px; }
        .btn-close { background: rgba(255,255,255,0.1); width:32px; height:32px; border-radius:50%; border: none; color: var(--text-main); font-size: 1rem; cursor: pointer; display:flex; align-items:center; justify-content:center;}

        .route-visual { display: flex; gap: 15px; margin-bottom: 10px; }
        .dots-col { display: flex; flex-direction: column; align-items: center; padding-top: 18px; }
        .dot-start { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); }
        .line { width: 2px; flex: 1; background: linear-gradient(to bottom, var(--accent), var(--danger)); opacity: 0.5; margin: 5px 0; border-radius: 2px; }
        .dot-end { width: 10px; height: 10px; background: var(--danger); border-radius: 50%; box-shadow: 0 0 10px var(--danger); }
        
        .inputs-col { flex: 1; display: flex; flex-direction: column; gap: 12px; position: relative; } 
        .input-field { width: 100%; padding: 16px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: var(--text-main); font-weight: 600; font-family: inherit; outline: none; box-sizing: border-box; transition: 0.3s; }
        .input-field:focus { border-color: var(--accent); background: rgba(0,0,0,0.5); box-shadow: 0 0 15px rgba(6, 182, 212, 0.1); }

        .suggestions-list { position: absolute; left: 0; right: 0; z-index: 100; top: 100%; background: #1a1a1a; border: 1px solid var(--glass-border); border-radius: 16px; max-height: 200px; overflow-y: auto; margin-top: 8px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .suggestions-list.active { display: block; }
        .suggestion-item { padding: 14px 18px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; font-size: 0.9rem; color: var(--text-muted); }
        .suggestion-item:hover { background: rgba(255,255,255,0.05); color: var(--accent); }
        .suggestion-item strong { color: var(--text-main); display:block; margin-bottom:2px;}

        .options-row { display: flex; gap: 10px; margin-top: 15px; }
        .visibility-toggle { flex: 1; display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 12px 16px; border-radius: 16px; cursor: pointer; border: 1px solid transparent; transition: 0.3s; }
        .visibility-toggle.active { border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .visibility-toggle i { font-size: 1.1rem; }
        
        .btn-fav-save { width: 54px; display: flex; justify-content: center; align-items: center; background: rgba(255,255,255,0.05); border-radius: 16px; border: 1px solid transparent; cursor: pointer; transition: 0.3s; }
        .btn-fav-save.saved { color: var(--danger); background: rgba(239, 68, 68, 0.15); border-color: var(--danger); }

        .btn-main { width: 100%; padding: 18px; border-radius: 18px; border: none; background: linear-gradient(90deg, var(--primary), var(--secondary)); color: white; font-size: 1rem; font-weight: 800; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4); transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-main:active { transform: scale(0.98); }

        .favorites-bar { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-top: 10px; scrollbar-width: none; }
        .fav-chip { background: rgba(255,255,255,0.08); padding: 8px 14px; border-radius: 50px; font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 6px; border: 1px solid transparent; }
        .fav-chip:active { background: var(--accent); color: black; }

        .bottom-sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(15, 15, 20, 0.95); backdrop-filter: blur(20px); border-radius: 30px 30px 0 0; padding: 0 20px 30px 20px; z-index: 1500; border-top: 1px solid var(--glass-border); transform: translateY(150%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); max-height: 60vh; overflow-y: auto; display: flex; flex-direction: column; box-sizing: border-box; box-shadow: 0 -10px 50px rgba(0,0,0,0.8); }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-header { position: sticky; top: 0; background: transparent; z-index: 10; padding-top: 15px; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .drag-handle { width: 50px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 10px; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); }
        .sheet-title { font-weight: 800; color: var(--accent); font-size: 0.9rem; letter-spacing: 2px; }

        .bus-item { display: flex; flex-direction: column; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 20px; margin-bottom: 12px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .bus-item:active { border-color: var(--accent); background: rgba(6, 182, 212, 0.05); }
        .bus-row-main { display: flex; align-items: center; width: 100%; } 
        .bus-info { flex: 1; margin-left: 15px; }
        .bus-name { color: var(--text-main); font-weight: 800; font-size: 1.1rem; }
        .bus-meta { color: var(--text-muted); font-size: 0.85rem; font-weight: 500; margin-top:2px;}
        .bus-matricule { background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 6px; color: var(--text-main); font-size: 0.75rem; font-family: monospace; letter-spacing: 1px; margin-left: 8px;}
        
        .fab-search { position: absolute; bottom: 30px; right: 20px; width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 20px var(--accent); z-index: 900; cursor: pointer; animation: float 4s ease-in-out infinite; border: 2px solid white; }
    </style>
</head>
<body>

    <script>if(!localStorage.getItem('user_session')) window.location.href = '/connexion';</script>

    <div class="top-bar">
        <div class="profile-chip">
            <img src="https://ui-avatars.com/api/?name=User&background=random" class="profile-img">
            <div class="profile-text">
                Shuttl<span style="color:var(--accent); font-size:1.2em;">.</span>
            </div>
        </div>
        <div class="top-right-group">
            <div class="round-btn" onclick="openNews()" style="background: var(--gold); border-color: var(--gold); color: black;">
                <i class="fas fa-newspaper"></i>
                <div class="notif-badge" style="border-color:var(--gold);"></div>
            </div>
            <div class="round-btn" onclick="location.reload()"> 
                <i class="fas fa-sync-alt"></i>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div class="fab-search" onclick="toggleSearch()" id="fabSearch" style="display:none;">
        <i class="fas fa-search" style="color:black; font-size:1.5rem;"></i>
    </div>

    <div class="news-modal" id="newsModal">
        <div class="sheet-header">
            <div class="drag-handle"></div>
            <div class="sheet-title" style="color:var(--accent); font-size:1.1rem;">ACTUALIT√âS TRANSPORT</div>
            <button class="btn-close" onclick="closeNews()"><i class="fas fa-times"></i></button>
        </div>
        <div id="newsList" class="news-content">
            <div style="text-align:center; color:var(--text-muted); margin-top:20px;">Chargement des infos...</div>
        </div>
    </div>

    <div class="search-overlay" id="searchOverlay"> <div class="search-card active">
            <div class="card-title">Planifier <button class="btn-close" onclick="toggleSearch()"><i class="fas fa-times"></i></button></div>
            <div class="route-visual">
                <div class="dots-col"><div class="dot-start"></div><div class="line"></div><div class="dot-end"></div></div>
                <div class="inputs-col">
                    <div style="position:relative;"><input type="text" class="input-field" id="txtDepart" placeholder="D'o√π partez-vous ?"><div id="listDepart" class="suggestions-list"></div></div>
                    <div style="position:relative;"><input type="text" class="input-field" id="txtArrivee" placeholder="O√π allez-vous ?"><div id="listArrivee" class="suggestions-list"></div></div>
                </div>
            </div>
            <div class="options-row">
                <div class="visibility-toggle active" id="btnVisibilite" onclick="toggleVisibility()">
                    <div style="display:flex; align-items:center; gap:10px;"><i class="fas fa-eye" id="visIcon" style="color:var(--success);"></i><span style="font-size:0.9rem; font-weight:700; color:var(--text-main);" id="visText">Visible</span></div>
                    <i class="fas fa-toggle-on" id="visToggleIcon" style="color:var(--success); font-size:1.2rem;"></i>
                </div>
                <div class="btn-fav-save" onclick="saveFavorite()"><i class="fas fa-heart"></i></div>
            </div>
            <button class="btn-main" onclick="lancerRecherche()">Trouver un Shuttl</button>
            <div class="favorites-bar" id="favContainer"></div>
        </div>
    </div>

    <div class="bottom-sheet" id="resultsSheet">
        <div class="sheet-header">
            <div class="drag-handle"></div>
            <div class="sheet-title">R√âSULTATS PROCHES</div>
            <button class="btn-close-sheet" onclick="fermerResultats()"><i class="fas fa-times"></i></button>
        </div>
        <div id="busList"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js').catch(console.error); }
        const SERVER_URL = "https://finaltrans.onrender.com"; 
        let passengerId = localStorage.getItem('my_passenger_id');
        if (!passengerId) { passengerId = 'user_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('my_passenger_id', passengerId); }

        let rechercheActive = false; let currentRouteLayer = null; let isVisibleToDriver = true;
        let userLat, userLon, userMarker; let userSpeed = 0; let busMarkers = {}; let map; let tileLayer; let isTraveling = false;
        const session = JSON.parse(localStorage.getItem('user_session'));

        function openNews() { document.getElementById('newsModal').classList.add('active'); fetchNews(); }
        function closeNews() { document.getElementById('newsModal').classList.remove('active'); }

        async function fetchNews() {
            const container = document.getElementById('newsList');
            try {
                const res = await fetch(SERVER_URL + '/api/news');
                const data = await res.json();
                if(data.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">Aucune nouvelle r√©cente sur le transport.</div>'; return; }
                container.innerHTML = '';
                data.forEach(item => {
                    const div = document.createElement('div'); div.className = 'news-item';
                    div.innerHTML = `<div class="news-source">${item.source} <span class="news-date">${item.date}</span></div><div class="news-title">${item.title}</div><div class="news-summary">${item.summary}</div>`;
                    div.onclick = () => window.open(item.link, '_blank'); container.appendChild(div);
                });
            } catch(e) { container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--danger);">Impossible de charger les infos.</div>'; }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false, fadeAnimation: true }).setView([36.72, 4.05], 13);
            tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { detectRetina: true, maxZoom: 20, keepBuffer: 10, updateWhenIdle: false }).addTo(map);
        }
        initMap();

        const iconBus = L.divIcon({ className: 'modern-bus-icon', html: '<i class="fas fa-bus"></i>', iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -25] });
        const iconUser = L.divIcon({ className: 'custom-div-icon', html: `<div class="pulse-ring"></div><div class="modern-user-icon" style="width:24px; height:24px;"></div>`, iconSize: [24, 24], iconAnchor: [12, 12] });
        const iconStation = L.divIcon({ className: 'station-icon', html: '', iconSize: [12, 12], iconAnchor: [6, 6] });

        function toggleSearch() { 
            const card = document.querySelector('.search-card'); const fab = document.getElementById('fabSearch');
            if(card.classList.contains('active')) { card.classList.remove('active'); fab.style.display = 'flex'; } 
            else { card.classList.add('active'); fab.style.display = 'none'; document.getElementById('resultsSheet').classList.remove('active'); }
        }
        document.querySelector('.search-card').classList.add('active');

        function fermerResultats() { document.getElementById('resultsSheet').classList.remove('active'); setTimeout(() => { document.querySelector('.search-card').classList.add('active'); }, 300); }

        function loadFavorites() {
            const favs = JSON.parse(localStorage.getItem('tizi_favs') || '[]'); const container = document.getElementById('favContainer'); container.innerHTML = '';
            favs.forEach((fav, index) => {
                const chip = document.createElement('div'); chip.className = 'fav-chip';
                chip.innerHTML = `<i class="fas fa-heart" style="color:var(--danger)"></i> ${fav.arr}`; 
                chip.onclick = () => { document.getElementById('txtDepart').value = fav.dep; document.getElementById('txtArrivee').value = fav.arr; lancerRecherche(); };
                chip.oncontextmenu = (e) => { e.preventDefault(); if(confirm("Supprimer ce favori ?")) { favs.splice(index, 1); localStorage.setItem('tizi_favs', JSON.stringify(favs)); loadFavorites(); } };
                container.appendChild(chip);
            });
        }
        function saveFavorite() {
            const dep = document.getElementById('txtDepart').value; const arr = document.getElementById('txtArrivee').value;
            if(!dep || !arr) return alert("Remplissez le trajet d'abord !");
            const favs = JSON.parse(localStorage.getItem('tizi_favs') || '[]'); favs.push({ dep, arr });
            localStorage.setItem('tizi_favs', JSON.stringify(favs));
            const btn = document.querySelector('.btn-fav-save'); btn.classList.add('saved'); setTimeout(() => btn.classList.remove('saved'), 1000); loadFavorites();
        }
        loadFavorites(); 

        function shareBus(busId, chauffeurNom) {
            const url = `${window.location.origin}${window.location.pathname}?bus=${busId}`;
            if (navigator.share) { navigator.share({ title: 'Suivre ce Shuttl', text: `Suis le bus de ${chauffeurNom} !`, url: url }).catch(console.error); } else { navigator.clipboard.writeText(url); alert("Lien copi√© !"); }
        }
        const urlParams = new URLSearchParams(window.location.search); const sharedBusId = urlParams.get('bus');
        if(sharedBusId) { rechercheActive = true; document.querySelector('.search-card').classList.remove('active'); document.getElementById('fabSearch').style.display = 'flex'; }

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                userLat = pos.coords.latitude; userLon = pos.coords.longitude; userSpeed = pos.coords.speed || 0;
                let speedKmH = userSpeed * 3.6; if (speedKmH > 15) { isTraveling = true; } else { isTraveling = false; }
                if(!userMarker) { userMarker = L.marker([userLat, userLon], {icon: iconUser}).addTo(map); map.setView([userLat, userLon], 14); } else { userMarker.setLatLng([userLat, userLon]); }
                if(rechercheActive) fetchBus();
            }, err => console.log(err), { enableHighAccuracy: true });
        }

        function setupAutocomplete(inputId, listId) {
            const input = document.getElementById(inputId); const list = document.getElementById(listId); let timeout = null;
            input.addEventListener('input', function() {
                const query = this.value; if(timeout) clearTimeout(timeout); if(query.length < 2) { list.classList.remove('active'); return; }
                timeout = setTimeout(async () => {
                    try {
                        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=dz&addressdetails=1&limit=5`;
                        const res = await fetch(url); const data = await res.json();
                        list.innerHTML = '';
                        if(data.length > 0) { list.classList.add('active'); data.forEach(item => { const name = item.name; const details = item.address.state || "Alg√©rie"; const div = document.createElement('div'); div.className = 'suggestion-item'; div.innerHTML = `<strong>${name}</strong> <span style="font-size:0.8rem;">(${details})</span>`; div.onclick = () => { input.value = name; list.classList.remove('active'); }; list.appendChild(div); }); } else { list.classList.remove('active'); }
                    } catch(e) {}
                }, 300);
            });
            document.addEventListener('click', (e) => { if(e.target !== input && e.target !== list) list.classList.remove('active'); });
        }
        setupAutocomplete('txtDepart', 'listDepart'); setupAutocomplete('txtArrivee', 'listArrivee');

        function toggleVisibility() {
            isVisibleToDriver = !isVisibleToDriver; const toggle = document.getElementById('visToggleIcon'); const text = document.getElementById('visText');
            document.getElementById('btnVisibilite').classList.toggle('active');
            if(isVisibleToDriver) { toggle.className = "fas fa-toggle-on"; toggle.style.color = "var(--success)"; text.innerText = "Visible"; document.getElementById('visIcon').style.color = "var(--success)"; } else { toggle.className = "fas fa-toggle-off"; toggle.style.color = "#64748b"; text.innerText = "Invisible"; document.getElementById('visIcon').style.color = "#64748b"; }
        }

        function lancerRecherche() {
            const dep = document.getElementById('txtDepart').value; const arr = document.getElementById('txtArrivee').value;
            if (currentRouteLayer) { map.removeLayer(currentRouteLayer); currentRouteLayer = null; }
            document.querySelectorAll('.leaflet-marker-icon .terminus-flag').forEach(el => el.parentElement.remove());
            if(!dep && !arr) return alert("Remplissez au moins une ville !");
            isTraveling = false; rechercheActive = true;
            document.querySelector('.search-card').classList.remove('active'); document.getElementById('fabSearch').style.display = 'flex'; 
            document.getElementById('resultsSheet').classList.add('active'); document.getElementById('busList').innerHTML = '<div style="text-align:center; padding:30px; color:var(--text-muted);"><i class="fas fa-satellite-dish fa-spin fa-2x"></i><br><br>Recherche de Shuttl...</div>';
            fetchBus();
        }

        async function afficherTrajet(bus) {
            if (!bus.terminus_officiel) return;
            if (currentRouteLayer) { map.removeLayer(currentRouteLayer); currentRouteLayer = null; }
            const start = `${bus.current_lon},${bus.current_lat}`; const end = `${bus.terminus_officiel.lon},${bus.terminus_officiel.lat}`;
            const url = `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=full&geometries=geojson`;
            try {
                const res = await fetch(url); const data = await res.json();
                if (data.routes && data.routes.length > 0) {
                    currentRouteLayer = L.geoJSON(data.routes[0].geometry, { style: { color: "#3b82f6", weight: 6, opacity: 0.9, lineCap: 'round' } }).addTo(map);
                    map.fitBounds(currentRouteLayer.getBounds(), { padding: [50, 50] });
                }
            } catch (e) { console.error("Erreur trajet:", e); }
        }

        function acheterTicket(chauffeur, prix) { alert(`üéüÔ∏è TICKET R√âSERV√â !\n\nüöç Bus : ${chauffeur}\nüí∞ Prix : ${prix} DA\n\nMontrez cet √©cran au chauffeur en montant.`); }

        async function fetchBus() {
            if(!rechercheActive && !sharedBusId) return; 
            const container = document.getElementById('busList'); const dep = document.getElementById('txtDepart').value; const arr = document.getElementById('txtArrivee').value;
            let effectiveVisibility = isVisibleToDriver; if (isTraveling) effectiveVisibility = false;
            try {
                const res = await fetch(SERVER_URL + '/api/trouver-bus', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_lat: userLat, user_lon: userLon, depart_text: dep, arrivee_text: arr, visible: effectiveVisibility, passenger_id: passengerId }) });
                const data = await res.json();
                container.innerHTML = ''; for(let id in busMarkers) map.removeLayer(busMarkers[id]); busMarkers = {};
                if(data.bus_proches && data.bus_proches.length > 0) {
                    data.bus_proches.forEach(bus => {
                        const m = L.marker([bus.current_lat, bus.current_lon], {icon: iconBus}).addTo(map);
                        m.bindPopup(`<div style="text-align:center; color:black; font-family:'Plus Jakarta Sans',sans-serif;"><div style="background:var(--accent); color:white; font-weight:800; padding:5px; border-radius:8px; margin-bottom:5px;">~ ${bus.eta || '?'} min</div><strong>${bus.chauffeur}</strong><br><span style="font-size:0.8rem;">${bus.modele}</span><br><span style="background:#facc15; padding:2px 5px; font-weight:bold; border-radius:4px;">${bus.matricule}</span></div>`);
                        m.on('click', () => { afficherTrajet(bus); }); busMarkers[bus.bus_id] = m;
                        if(sharedBusId && bus.bus_id === sharedBusId) { map.setView([bus.current_lat, bus.current_lon], 16); m.openPopup(); afficherTrajet(bus); }
                        
                        let ticketHtml = ''; if (bus.ticket_actif) { ticketHtml = `<button onclick="event.stopPropagation(); acheterTicket('${bus.chauffeur}', '${bus.ticket_prix}')" style="margin-top:12px; width:100%; background: linear-gradient(135deg, #f59e0b, #d97706); border:none; padding:12px; border-radius:12px; color:white; font-weight:800; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); transition:0.2s;"><i class="fas fa-ticket-alt"></i> Acheter Ticket (${bus.ticket_prix} DA)</button>`; }
                        
                        const div = document.createElement('div'); div.className = 'bus-item';
                        div.innerHTML = `<div class="bus-row-main"><div style="background:rgba(255,255,255,0.1); width:45px; height:45px; border-radius:12px; display:flex; justify-content:center; align-items:center;"><i class="fas fa-bus" style="color:var(--accent); font-size:1.2rem;"></i></div><div class="bus-info"><div class="bus-name">${bus.chauffeur}</div><div class="bus-meta">${bus.modele} <span class="bus-matricule">${bus.matricule}</span></div><div class="bus-sub" style="color:var(--accent); font-weight:bold; margin-top:4px;"><i class="fas fa-bolt"></i> ${bus.eta || '?'} min <span style="color:var(--text-muted); font-weight:normal; margin-left:5px;">(${bus.distance_km} km)</span></div></div><button class="btn-share" onclick="event.stopPropagation(); shareBus('${bus.bus_id}', '${bus.chauffeur}')"><i class="fas fa-share" style="color:white;"></i></button></div>${ticketHtml}`;
                        div.onclick = () => { afficherTrajet(bus); map.setView([bus.current_lat, bus.current_lon], 16); m.openPopup(); }; container.appendChild(div);
                    });
                } else { container.innerHTML = '<div style="padding:40px 20px; text-align:center; color:var(--text-muted);">Aucun Shuttl trouv√© pour le moment.<br><small>Essayez une autre destination</small></div>'; }
            } catch(e) { console.error(e); }
        }

        let busStopsLayer = L.layerGroup().addTo(map); 
        async function chargerArretsOsm() {
            const bounds = map.getBounds(); if(map.getZoom() < 14) { busStopsLayer.clearLayers(); return; }
            const south = bounds.getSouth(); const west = bounds.getWest(); const north = bounds.getNorth(); const east = bounds.getEast();
            const query = `[out:json][timeout:25];(node["highway"="bus_stop"](${south},${west},${north},${east});node["public_transport"="platform"](${south},${west},${north},${east}););out body;`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            try {
                const res = await fetch(url); const data = await res.json();
                busStopsLayer.clearLayers(); data.elements.forEach(element => { const nom = element.tags.name || "Arr√™t"; L.marker([element.lat, element.lon], {icon: iconStation}).bindPopup(`<b style="color:black">${nom}</b>`).addTo(busStopsLayer); });
            } catch (e) { console.error("Erreur OSM:", e); }
        }
        map.on('moveend', chargerArretsOsm);
        setInterval(fetchBus, 1000); 
    </script>
</body>
</html>

---

### 2. Fichier `app.py` (Correction des Indentations)

Voici le code **app.py** enti√®rement nettoy√©. Il utilise des espaces standards (4 espaces) et n'a plus de caract√®res cach√©s.

```python
import os
import math
import datetime 
import feedparser
from dateutil import parser as date_parser
from flask import Flask, request, jsonify, send_from_directory
from supabase import create_client, Client
from flask_cors import CORS
from dotenv import load_dotenv

# --- CONFIGURATION ---
load_dotenv()
app = Flask(__name__)
CORS(app)

# R√©cup√©ration des cl√©s
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")

# Nettoyage des cl√©s (au cas o√π il y a des guillemets dans le .env)
if SUPABASE_URL: 
    SUPABASE_URL = SUPABASE_URL.strip().strip("'").strip('"')
if SUPABASE_KEY: 
    SUPABASE_KEY = SUPABASE_KEY.strip().strip("'").strip('"')

# Connexion Supabase
if not SUPABASE_URL or not SUPABASE_KEY:
    print("‚ö†Ô∏è ERREUR: Les cl√©s SUPABASE_URL ou SUPABASE_KEY sont manquantes.")
    supabase = None
else:
    supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

# --- 1. LE CERVEAU G√âOGRAPHIQUE ---
CITIES_DB = {
    "tizi ouzou": {"lat": 36.7118, "lon": 4.0505},
    "tizi": {"lat": 36.7118, "lon": 4.0505},
    "alger": {"lat": 36.7528, "lon": 3.0420},
    "oran": {"lat": 35.6971, "lon": -0.6308},
    "bejaia": {"lat": 36.7509, "lon": 5.0567},
    "bouira": {"lat": 36.3749, "lon": 3.9020},
    "draa ben khedda": {"lat": 36.7333, "lon": 3.9667},
    "dbk": {"lat": 36.7333, "lon": 3.9667},
    "azazga": {"lat": 36.7447, "lon": 4.3722},
    "freha": {"lat": 36.7667, "lon": 4.3167},
    "tamda": {"lat": 36.7167, "lon": 4.1333}
}

def haversine(lat1, lon1, lat2, lon2):
    """Calcul la distance en KM entre deux points GPS"""
    try:
        if not lat1 or not lon1 or not lat2 or not lon2: return 0
        R = 6371.0
        dlat = math.radians(lat2 - lat1)
        dlon = math.radians(lon2 - lon1)
        a = math.sin(dlat / 2)**2 + math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) * math.sin(dlon / 2)**2
        c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
        return round(R * c, 2)
    except:
        return 0

# --- ROUTES PAGES (FRONTEND) ---
@app.route('/')
def home(): return send_from_directory('.', 'connexion.html')
@app.route('/inscription')
def page_inscription(): return send_from_directory('.', 'inscription.html')
@app.route('/connexion')
def page_connexion(): return send_from_directory('.', 'connexion.html')
@app.route('/voyageur')
def page_voyageur(): return send_from_directory('.', 'index.html')
@app.route('/chauffeur')
def page_chauffeur(): return send_from_directory('.', 'chauffeur.html')
@app.route('/<path:path>')
def static_file(path): return send_from_directory('.', path)

# --- API 1 : INSCRIPTION ---
@app.route('/api/register', methods=['POST'])
def register():
    data = request.json
    role = data.get('role')
    email = data.get('email')
    password = data.get('password')
    
    try:
        auth = supabase.auth.sign_up({"email": email, "password": password})
        
        if auth.user:
            uid = auth.user.id
            
            if role == 'chauffeur':
                supabase.table('drivers').insert({
                    'id': uid,
                    'nom_complet': data.get('nom'),
                    'telephone': data.get('tel'),
                    'ville_depart': data.get('v_depart', '').lower().strip(),
                    'ville_arrivee': data.get('v_arrivee', '').lower().strip(),
                    'matricule_vehicule': data.get('matricule'),
                    'modele_vehicule': data.get('modele'),
                    'dep_lat': data.get('dep_lat'),
                    'dep_lon': data.get('dep_lon'),
                    'arr_lat': data.get('arr_lat'),
                    'arr_lon': data.get('arr_lon')
                }).execute()
            else:
                supabase.table('passengers').insert({
                    'id': uid, 'nom_complet': data.get('nom'), 'telephone': data.get('tel')
                }).execute()
            
            return jsonify({"status": "success"})
        return jsonify({"error": "Echec authentification"}), 400
    except Exception as e:
        print(f"Erreur Register: {e}")
        return jsonify({"error": str(e)}), 500

# --- API 2 : CONNEXION ---
@app.route('/api/login', methods=['POST'])
def login():
    data = request.json
    try:
        auth = supabase.auth.sign_in_with_password({"email": data.get('email'), "password": data.get('password')})
        uid = auth.user.id
        
        driver = supabase.table('drivers').select('*').eq('id', uid).execute()
        if driver.data:
            return jsonify({"status": "success", "role": "chauffeur", "user": driver.data[0]})
        
        passenger = supabase.table('passengers').select('*').eq('id', uid).execute()
        if passenger.data:
            return jsonify({"status": "success", "role": "voyageur", "user": passenger.data[0]})
            
        return jsonify({"error": "R√¥le inconnu"}), 400
    except: return jsonify({"error": "Email ou mot de passe incorrect"}), 401

# --- API 3 : MISE A JOUR POSITION ---
@app.route('/api/update-position', methods=['POST'])
def update_position():
    data = request.json
    driver_id = data.get('id')
    lat = data.get('lat')
    lon = data.get('lon')

    try:
        driver_info = supabase.table('drivers').select('*').eq('id', driver_id).execute().data
        if not driver_info: return jsonify({"error": "Chauffeur inconnu"}), 404
        driver = driver_info[0]
        
        v_dep_nom = driver.get('ville_depart', '')
        v_arr_nom = driver.get('ville_arrivee', '')

        coord_dep = None
        if driver.get('dep_lat'): coord_dep = {'lat': driver['dep_lat'], 'lon': driver['dep_lon']}
        else: coord_dep = CITIES_DB.get(v_dep_nom)

        coord_arr = None
        if driver.get('arr_lat'): coord_arr = {'lat': driver['arr_lat'], 'lon': driver['arr_lon']}
        else: coord_arr = CITIES_DB.get(v_arr_nom)

        destination_actuelle = "Inconnue"

        if coord_dep and coord_arr:
            dist_to_dep = haversine(lat, lon, coord_dep['lat'], coord_dep['lon'])
            dist_to_arr = haversine(lat, lon, coord_arr['lat'], coord_arr['lon'])

            if dist_to_arr < 0.3:
                supabase.table('active_trips').delete().eq('chauffeur_id', driver_id).execute()
                return jsonify({
                    "status": "finished", 
                    "message": "Vous √™tes arriv√© au terminus. Mode hors ligne activ√©."
                })

            if dist_to_dep < dist_to_arr:
                destination_actuelle = v_arr_nom 
            else:
                destination_actuelle = v_dep_nom 

        supabase.table('active_trips').upsert({
            'chauffeur_id': driver_id,
            'current_lat': lat,
            'current_lon': lon,
            'direction_actuelle': destination_actuelle,
            'last_update': 'now()'
        }).execute()

        voyageurs_visibles = []
        try:
            fifteen_mins_ago = (datetime.datetime.utcnow() - datetime.timedelta(minutes=15)).isoformat()
            requests = supabase.table('passenger_requests').select('*').gt('created_at', fifteen_mins_ago).execute().data
            
            if requests:
                current_dest_clean = destination_actuelle.lower().strip()
                for req in requests:
                    r_arr = (req.get('arrivee_text') or "").lower().strip()
                    is_match = False
                    if r_arr and current_dest_clean and (r_arr in current_dest_clean or current_dest_clean in r_arr):
                        is_match = True
                    if is_match and req.get('user_lat'):
                        voyageurs_visibles.append({'lat': req['user_lat'], 'lon': req['user_lon']})
        except Exception as e:
            print(f"Erreur recup voyageurs: {e}")
        
        return jsonify({
            "status": "updated", 
            "direction": destination_actuelle,
            "voyageurs": voyageurs_visibles
        })
        
    except Exception as e: return jsonify({"error": str(e)}), 500

# --- ROUTE STOP ---
@app.route('/api/stop-driving', methods=['POST'])
def stop_driving():
    data = request.json
    driver_id = data.get('id')
    try:
        supabase.table('active_trips').delete().eq('chauffeur_id', driver_id).execute()
        return jsonify({'status': 'success', 'message': 'Vous √™tes hors ligne'})
    except Exception as e:
        return jsonify({'status': 'error', 'error': str(e)}), 500

# --- ROUTES STATIQUES ---
@app.route('/manifest.json')
def serve_manifest(): return send_from_directory('.', 'manifest.json')
@app.route('/sw.js')
def serve_sw(): return send_from_directory('.', 'sw.js')

# --- API 4 : TROUVER BUS ---
@app.route('/api/trouver-bus', methods=['POST'])
def api_trouver_bus():
    data = request.json
    user_lat = data.get('user_lat')
    user_lon = data.get('user_lon')
    is_visible = data.get('visible', True)

    def clean_text(t):
        if not t: return ""
        return t.lower().replace('-', ' ').strip()

    txt_dep = clean_text(data.get('depart_text', ''))
    txt_arr = clean_text(data.get('arrivee_text', ''))

    has_dep = len(txt_dep) > 0
    has_arr = len(txt_arr) > 0
    recherche_active = (has_dep or has_arr)

    if is_visible and recherche_active and user_lat and user_lon:
        try:
            supabase.table('passenger_requests').insert({
                'user_lat': user_lat, 'user_lon': user_lon,
                'depart_text': txt_dep, 'arrivee_text': txt_arr
            }).execute()
        except Exception as e: print(f"‚ö†Ô∏è Erreur: {e}")

    try:
        timeout_limit = (datetime.datetime.utcnow() - datetime.timedelta(seconds=45)).isoformat()
        active_trips = supabase.table('active_trips').select('*').gt('last_update', timeout_limit).execute().data
        bus_proches = []

        for trip in active_trips:
            try:
                driver_req = supabase.table('drivers').select('*').eq('id', trip['chauffeur_id']).execute()
                if not driver_req.data: continue
                driver = driver_req.data[0]
            except: continue

            v1 = clean_text(driver.get('ville_depart', ''))
            v2 = clean_text(driver.get('ville_arrivee', ''))
            direction_reelle = clean_text(trip.get('direction_actuelle', ''))

            if recherche_active:
                bus_sur_la_ligne = False
                match_v1 = (txt_dep in v1 or txt_arr in v1)
                match_v2 = (txt_dep in v2 or txt_arr in v2)
                if has_dep and has_arr:
                    if (txt_dep in v1 and txt_arr in v2) or (txt_dep in v2 and txt_arr in v1): bus_sur_la_ligne = True
                elif match_v1 or match_v2: bus_sur_la_ligne = True
                if not bus_sur_la_ligne: continue

            coord_destination_user = None
            if has_arr:
                if txt_arr in v1: 
                     if driver.get('dep_lat'): coord_destination_user = {'lat': driver['dep_lat'], 'lon': driver['dep_lon']}
                     else: coord_destination_user = CITIES_DB.get(v1)
                elif txt_arr in v2:
                     if driver.get('arr_lat'): coord_destination_user = {'lat': driver['arr_lat'], 'lon': driver['arr_lon']}
                     else: coord_destination_user = CITIES_DB.get(v2)
                if not coord_destination_user:
                     for k in CITIES_DB:
                         if k in txt_arr: coord_destination_user = CITIES_DB[k]; break

            if direction_reelle and has_arr:
                if txt_arr not in direction_reelle: continue 

            if user_lat and trip['current_lat'] and coord_destination_user:
                dist_user_to_dest = haversine(user_lat, user_lon, coord_destination_user['lat'], coord_destination_user['lon'])
                dist_bus_to_dest = haversine(trip['current_lat'], trip['current_lon'], coord_destination_user['lat'], coord_destination_user['lon'])
                if dist_bus_to_dest < (dist_user_to_dest - 2.0): continue 

            real_dep_coord = None
            if driver.get('dep_lat') and driver.get('dep_lon'):
                real_dep_coord = {'lat': driver['dep_lat'], 'lon': driver['dep_lon']}
            else: real_dep_coord = CITIES_DB.get(v1)

            real_arr_coord = None
            if driver.get('arr_lat') and driver.get('arr_lon'):
                real_arr_coord = {'lat': driver['arr_lat'], 'lon': driver['arr_lon']}
            else: real_arr_coord = CITIES_DB.get(v2)

            coord_dep_ligne = None
            coord_arr_ligne = None
            if direction_reelle in v1:
                coord_arr_ligne = real_dep_coord
                coord_dep_ligne = real_arr_coord
            else:
                coord_arr_ligne = real_arr_coord
                coord_dep_ligne = real_dep_coord

            dist_user_bus = 0
            eta_min = 0 
            if user_lat and trip['current_lat']:
                dist_user_bus = haversine(user_lat, user_lon, trip['current_lat'], trip['current_lon'])
                vitesse_moyenne = 25.0 
                temps_heures = dist_user_bus / vitesse_moyenne
                eta_min = int(temps_heures * 60)
                if eta_min < 1: eta_min = 1

            bus_proches.append({
                'bus_id': trip['chauffeur_id'],
                'chauffeur': driver['nom_complet'],
                'modele': driver.get('modele_vehicule', 'Bus'),
                'matricule': driver.get('matricule_vehicule', ''),
                'current_lat': trip['current_lat'],
                'current_lon': trip['current_lon'],
                'distance_km': round(dist_user_bus, 1),
                'eta': eta_min,
                'direction': direction_reelle,
                'terminus_officiel': coord_arr_ligne, 
                'ligne_start': coord_dep_ligne,
                'ligne_end': coord_arr_ligne,
                'ticket_actif': driver.get('ticket_actif', False),
                'ticket_prix': driver.get('ticket_prix', 0)
            })

        bus_proches.sort(key=lambda x: x['distance_km'])
        return jsonify({"bus_proches": bus_proches})

    except Exception as e:
        print(f"üî¥ ERREUR: {e}")
        return jsonify({"bus_proches": []})

# --- API 5 : UPDATE PROFILE ---
@app.route('/api/update-driver-profile', methods=['POST'])
def update_driver_profile():
    data = request.json
    uid = data.get('id')
    try:
        update_data = {
            'nom_complet': data.get('nom_complet'),
            'modele_vehicule': data.get('modele_vehicule'),
            'matricule_vehicule': data.get('matricule_vehicule'),
            'ville_depart': data.get('ville_depart', '').lower().strip(),
            'ville_arrivee': data.get('ville_arrivee', '').lower().strip(),
        }
        
        if data.get('dep_lat'): update_data['dep_lat'] = data.get('dep_lat')
        if data.get('dep_lon'): update_data['dep_lon'] = data.get('dep_lon')
        if data.get('arr_lat'): update_data['arr_lat'] = data.get('arr_lat')
        if data.get('arr_lon'): update_data['arr_lon'] = data.get('arr_lon')

        if 'ticket_actif' in data: update_data['ticket_actif'] = data.get('ticket_actif')
        if 'ticket_prix' in data: update_data['ticket_prix'] = data.get('ticket_prix')

        supabase.table('drivers').update(update_data).eq('id', uid).execute()
        return jsonify({"status": "success"})
    except Exception as e:
        return jsonify({"error": str(e)}), 500

# --- API 6 : NEWS ALGERIE ---
@app.route('/api/news', methods=['GET'])
def get_transport_news():
    rss_urls = [
        "[https://www.tsa-algerie.com/feed/](https://www.tsa-algerie.com/feed/)",
        "[https://www.algerie360.com/feed/](https://www.algerie360.com/feed/)",
        "[https://www.aps.dz/algerie?format=feed](https://www.aps.dz/algerie?format=feed)"
    ]
    keywords = ["transport", "bus", "tramway", "m√©tro", "route", "circulation", "tizi ouzou", "naftal", "etusa", "train", "sntf", "autoroute"]
    news_items = []

    try:
        for url in rss_urls:
            feed = feedparser.parse(url)
            for entry in feed.entries:
                text_content = (entry.title + " " + entry.description).lower()
                if any(k in text_content for k in keywords):
                    try:
                        dt = date_parser.parse(entry.published)
                        date_str = dt.strftime("%d/%m %H:%M")
                    except:
                        date_str = "R√©cemment"

                    summary_text = entry.description.replace('<p>', '').replace('</p>', '')[:120] + "..."

                    news_items.append({
                        "title": entry.title,
                        "link": entry.link,
                        "source": feed.feed.title.split('-')[0].strip()[:15], 
                        "date": date_str,
                        "summary": summary_text
                    })
        
        return jsonify(news_items[:10]) 
    except Exception as e:
        print(f"Erreur News: {e}")
        return jsonify([])

# --- POINT D'ENTR√âE RENDER (PORT DYNAMIQUE) ---
if __name__ == '__main__':
    port = int(os.environ.get("PORT", 5000))
    app.run(host='0.0.0.0', port=port)
