<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <title>Shuttl</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- NOUVELLE PALETTE "CYBER-GLASS" --- */
            --bg-body: #000000;
            --glass-bg: rgba(20, 20, 20, 0.65); /* Fond transparent sombre */
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary: #3b82f6;      /* Bleu Principal */
            --secondary: #8b5cf6;    /* Violet (Dégradé) */
            --accent: #06b6d4;       /* Cyan (Lumière) */
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --danger: #ef4444;
            --success: #10b981;
            --gold: #f59e0b;         /* Couleur Ticket */
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        body { 
            margin: 0; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-body); 
            overflow: hidden; 
            color: var(--text-main);
        }
        
        #map { height: 100vh; width: 100%; z-index: 1; background: #111; }
        .leaflet-control-attribution { display: none; }

        /* --- ANIMATIONS --- */
        @keyframes float { 0% {transform: translateY(0px);} 50% {transform: translateY(-5px);} 100% {transform: translateY(0px);} }
        @keyframes pulse-glow { 0% {box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(6, 182, 212, 0);} 100% {box-shadow: 0 0 0 0 rgba(6, 182, 212, 0);} }
        
        /* --- ICÔNES MODERNES --- */
        .modern-bus-icon {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px; color: white; display: flex; justify-content: center; align-items: center;
            font-size: 1.1rem; 
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6); 
            border: 2px solid rgba(255,255,255,0.8);
            transition: transform 0.3s;
            z-index: 1000 !important;
        }
        
        .modern-user-icon {
            background: var(--accent);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 15px var(--accent);
        }
        .pulse-ring {
            border: 2px solid var(--accent); border-radius: 50%; height: 50px; width: 50px;
            position: absolute; left: -13px; top: -13px; animation: pulse-glow 2s infinite; opacity: 0;
        }

        .station-icon { 
            background: #262626; border: 2px solid #525252; 
            border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.5); 
        }

        /* --- INTERFACE GLASSMORPHISM --- */
        .top-bar { 
            position: absolute; top: 0; left: 0; right: 0; 
            padding: 20px; display: flex; justify-content: space-between; align-items: center; 
            z-index: 1000; pointer-events: none; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        .profile-chip { 
            pointer-events: auto; 
            background: var(--glass-bg); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 6px 16px 6px 6px; 
            border-radius: 50px; 
            display: flex; align-items: center; gap: 12px; 
            border: 1px solid var(--glass-border); 
            box-shadow: var(--shadow);
        }
        .profile-img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--accent); }
        .profile-text { font-size: 0.95rem; color: var(--text-main); font-weight: 700; letter-spacing: 0.5px; }
        
        .top-right-group { display: flex; gap: 12px; pointer-events: auto; }
        .round-btn { 
            width: 48px; height: 48px; 
            background: var(--glass-bg); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            border: 1px solid var(--glass-border); 
            cursor: pointer; color: var(--text-main); 
            transition: 0.3s; 
            box-shadow: var(--shadow);
            position: relative;
        }
        .round-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.1); }
        
        /* Badge Notification */
        .notif-badge { position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: var(--danger); border-radius: 50%; border: 2px solid black; display:none; }

        /* --- STYLES ACTUALITÉS (NEWS) --- */
        .news-modal { position: absolute; bottom: 0; left: 0; width: 100%; height: 90vh; background: #111; border-radius: 30px 30px 0 0; z-index: 2500; transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; box-sizing: border-box; padding: 25px; border-top: 1px solid var(--glass-border); }
        .news-modal.active { transform: translateY(0); }
        .news-content { overflow-y: auto; flex: 1; padding-bottom: 50px; }
        .news-item {
            background: rgba(255,255,255,0.05); border-radius: 16px; padding: 15px;
            margin-bottom: 15px; border: 1px solid var(--glass-border);
            transition: 0.2s; cursor: pointer;
        }
        .news-item:active { background: rgba(255,255,255,0.1); }
        .news-source { font-size: 0.75rem; color: var(--accent); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display:flex; justify-content:space-between;}
        .news-title { font-size: 1rem; font-weight: 700; line-height: 1.4; margin-bottom: 8px; color: white; }
        .news-summary { font-size: 0.85rem; color: var(--text-muted); line-height: 1.4; }
        .news-date { color: var(--text-muted); font-weight: 400; }

        /* --- RECHERCHE --- */
        .search-overlay { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: auto; 
            z-index: 2000; 
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; 
            pointer-events: none; 
        }
        
        .search-card { 
            pointer-events: auto;
            background: rgba(15, 15, 20, 0.85); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 25px; 
            border-radius: 30px; 
            border: 1px solid var(--glass-border); 
            width: 100%; max-width: 450px; 
            margin: 0 auto; 
            box-sizing: border-box; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .search-card.active { transform: translateY(0); }

        .card-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; letter-spacing: 1px; }
        .btn-close { background: rgba(255,255,255,0.1); width:32px; height:32px; border-radius:50%; border: none; color: var(--text-main); font-size: 1rem; cursor: pointer; display:flex; align-items:center; justify-content:center;}

        /* Visualisation Trajet */
        .route-visual { display: flex; gap: 15px; margin-bottom: 10px; }
        .dots-col { display: flex; flex-direction: column; align-items: center; padding-top: 18px; }
        .dot-start { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); }
        .line { width: 2px; flex: 1; background: linear-gradient(to bottom, var(--accent), var(--danger)); opacity: 0.5; margin: 5px 0; border-radius: 2px; }
        .dot-end { width: 10px; height: 10px; background: var(--danger); border-radius: 50%; box-shadow: 0 0 10px var(--danger); }
        
        .inputs-col { flex: 1; display: flex; flex-direction: column; gap: 12px; position: relative; } 
        .input-field { 
            width: 100%; padding: 16px; 
            border-radius: 16px; 
            border: 1px solid rgba(255,255,255,0.1); 
            background: rgba(0,0,0,0.3); 
            color: var(--text-main); font-weight: 600; font-family: inherit; 
            outline: none; box-sizing: border-box; 
            transition: 0.3s;
        }
        .input-field:focus { border-color: var(--accent); background: rgba(0,0,0,0.5); box-shadow: 0 0 15px rgba(6, 182, 212, 0.1); }

        /* Suggestions */
        .suggestions-list { 
            position: absolute; left: 0; right: 0; z-index: 100; top: 100%;
            background: #1a1a1a; border: 1px solid var(--glass-border); 
            border-radius: 16px; max-height: 200px; overflow-y: auto; 
            margin-top: 8px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .suggestions-list.active { display: block; }
        .suggestion-item { padding: 14px 18px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; font-size: 0.9rem; color: var(--text-muted); }
        .suggestion-item:hover { background: rgba(255,255,255,0.05); color: var(--accent); }
        .suggestion-item strong { color: var(--text-main); display:block; margin-bottom:2px;}

        /* Options */
        .options-row { display: flex; gap: 10px; margin-top: 15px; }
        .visibility-toggle { 
            flex: 1; display: flex; align-items: center; justify-content: space-between; 
            background: rgba(255,255,255,0.05); padding: 12px 16px; border-radius: 16px; 
            cursor: pointer; border: 1px solid transparent; transition: 0.3s;
        }
        .visibility-toggle.active { border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .visibility-toggle i { font-size: 1.1rem; }
        
        .btn-fav-save { 
            width: 54px; display: flex; justify-content: center; align-items: center; 
            background: rgba(255,255,255,0.05); border-radius: 16px; 
            border: 1px solid transparent; cursor: pointer; transition: 0.3s;
        }
        .btn-fav-save.saved { color: var(--danger); background: rgba(239, 68, 68, 0.15); border-color: var(--danger); }

        .btn-main { 
            width: 100%; padding: 18px; border-radius: 18px; border: none; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            color: white; font-size: 1rem; font-weight: 800; cursor: pointer; margin-top: 20px; 
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-main:active { transform: scale(0.98); }

        .favorites-bar { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-top: 10px; scrollbar-width: none; }
        .fav-chip { 
            background: rgba(255,255,255,0.08); padding: 8px 14px; border-radius: 50px; 
            font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; cursor: pointer; 
            display: flex; align-items: center; gap: 6px; border: 1px solid transparent;
        }
        .fav-chip:active { background: var(--accent); color: black; }

        /* Résultats */
        .bottom-sheet { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: rgba(15, 15, 20, 0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 30px 30px 0 0; padding: 0 20px 30px 20px; z-index: 1500; 
            border-top: 1px solid var(--glass-border); 
            transform: translateY(150%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            max-height: 60vh; overflow-y: auto; display: flex; flex-direction: column; 
            box-sizing: border-box;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
        }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-header { position: sticky; top: 0; background: transparent; z-index: 10; padding-top: 15px; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .drag-handle { width: 50px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 10px; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); }
        .sheet-title { font-weight: 800; color: var(--accent); font-size: 0.9rem; letter-spacing: 2px; }

        .bus-item { 
            display: flex; flex-direction: column; /* Changé pour accomoder le bouton */
            padding: 16px; 
            background: rgba(255,255,255,0.03); border-radius: 20px; 
            margin-bottom: 12px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; 
        }
        .bus-item:active { border-color: var(--accent); background: rgba(6, 182, 212, 0.05); }
        
        .bus-row-main { display: flex; align-items: center; width: 100%; } /* Ligne principale */
        
        .bus-info { flex: 1; margin-left: 15px; }
        .bus-name { color: var(--text-main); font-weight: 800; font-size: 1.1rem; }
        .bus-meta { color: var(--text-muted); font-size: 0.85rem; font-weight: 500; margin-top:2px;}
        .bus-matricule { background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 6px; color: var(--text-main); font-size: 0.75rem; font-family: monospace; letter-spacing: 1px; margin-left: 8px;}
        
        /* Bouton Flottant "Recherche" */
        .fab-search {
            position: absolute; bottom: 30px; right: 20px;
            width: 60px; height: 60px;
            background: var(--accent);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 20px var(--accent);
            z-index: 900;
            cursor: pointer;
            animation: float 4s ease-in-out infinite;
            border: 2px solid white;
        }
    </style>
</head>
<body>

    <script>if(!localStorage.getItem('user_session')) window.location.href = '/connexion';</script>

    <div class="top-bar">
        <div class="profile-chip">
            <img src="https://ui-avatars.com/api/?name=User&background=random" class="profile-img">
            <div class="profile-text">
                Shuttl<span style="color:var(--accent); font-size:1.2em;">.</span>
            </div>
        </div>
        <div class="top-right-group">
            <div class="round-btn" onclick="openNews()">
                <i class="far fa-newspaper"></i>
                <div class="notif-badge"></div>
            </div>
            <div class="round-btn" onclick="location.reload()"> 
                <i class="fas fa-sync-alt"></i>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div class="fab-search" onclick="toggleSearch()" id="fabSearch" style="display:none;">
        <i class="fas fa-search" style="color:black; font-size:1.5rem;"></i>
    </div>

    <div class="news-modal" id="newsModal">
        <div class="sheet-header">
            <div class="drag-handle"></div>
            <div class="sheet-title" style="color:var(--accent); font-size:1.1rem;">ACTUALITÉS TRANSPORT</div>
            <button class="btn-close" onclick="closeNews()"><i class="fas fa-times"></i></button>
        </div>
        <div id="newsList" class="news-content">
            <div style="text-align:center; color:var(--text-muted); margin-top:20px;">Chargement des infos...</div>
        </div>
    </div>

    <div class="search-overlay" id="searchOverlay"> <div class="search-card active">
            <div class="card-title">
                Planifier
                <button class="btn-close" onclick="toggleSearch()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="route-visual">
                <div class="dots-col"><div class="dot-start"></div><div class="line"></div><div class="dot-end"></div></div>
                <div class="inputs-col">
                    <div style="position:relative;">
                        <input type="text" class="input-field" id="txtDepart" placeholder="D'où partez-vous ?">
                        <div id="listDepart" class="suggestions-list"></div>
                    </div>
                    <div style="position:relative;">
                        <input type="text" class="input-field" id="txtArrivee" placeholder="Où allez-vous ?">
                        <div id="listArrivee" class="suggestions-list"></div>
                    </div>
                </div>
            </div>

            <div class="options-row">
                <div class="visibility-toggle active" id="btnVisibilite" onclick="toggleVisibility()">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-eye" id="visIcon" style="color:var(--success);"></i>
                        <span style="font-size:0.9rem; font-weight:700; color:var(--text-main);" id="visText">Visible</span>
                    </div>
                    <i class="fas fa-toggle-on" id="visToggleIcon" style="color:var(--success); font-size:1.2rem;"></i>
                </div>
                <div class="btn-fav-save" onclick="saveFavorite()">
                    <i class="fas fa-heart"></i>
                </div>
            </div>

            <button class="btn-main" onclick="lancerRecherche()">
                Trouver un Shuttl
            </button>

            <div class="favorites-bar" id="favContainer"></div>
        </div>
    </div>

    <div class="bottom-sheet" id="resultsSheet">
        <div class="sheet-header">
            <div class="drag-handle"></div>
            <div class="sheet-title">RÉSULTATS PROCHES</div>
            <button class="btn-close-sheet" onclick="fermerResultats()"><i class="fas fa-times"></i></button>
        </div>
        <div id="busList"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // --- 1. CONFIGURATION SYSTEME ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        }
        const SERVER_URL = "https://finaltrans.onrender.com"; 
        
        let passengerId = localStorage.getItem('my_passenger_id');
        if (!passengerId) {
            passengerId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('my_passenger_id', passengerId);
        }

        let rechercheActive = false;
        let currentRouteLayer = null; 
        let isVisibleToDriver = true;
        let userLat, userLon, userMarker;
        let userSpeed = 0;
        let busMarkers = {};
        let map; 
        let tileLayer;
        let isTraveling = false;

        const session = JSON.parse(localStorage.getItem('user_session'));
        
        // --- 2. GESTION DES NEWS (NOUVEAU) ---
        function openNews() {
            document.getElementById('newsModal').classList.add('active');
            fetchNews();
        }
        function closeNews() { document.getElementById('newsModal').classList.remove('active'); }

        async function fetchNews() {
            const container = document.getElementById('newsList');
            try {
                const res = await fetch(SERVER_URL + '/api/news');
                const data = await res.json();
                
                if(data.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">Aucune nouvelle récente sur le transport.</div>';
                    return;
                }

                container.innerHTML = '';
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'news-item';
                    div.innerHTML = `
                        <div class="news-source">${item.source} <span class="news-date">${item.date}</span></div>
                        <div class="news-title">${item.title}</div>
                        <div class="news-summary">${item.summary}</div>
                    `;
                    div.onclick = () => window.open(item.link, '_blank');
                    container.appendChild(div);
                });
            } catch(e) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--danger);">Impossible de charger les infos.</div>';
            }
        }

        // --- 3. CARTE "DARK MATTER" ---
        function initMap() {
            map = L.map('map', { zoomControl: false, fadeAnimation: true }).setView([36.72, 4.05], 13);
            const themeUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
            tileLayer = L.tileLayer(themeUrl, {
                detectRetina: true, maxZoom: 20, keepBuffer: 10, updateWhenIdle: false, attribution: ''
            }).addTo(map);
        }
        initMap();

        // --- 4. LOGIQUE UI ---
        function toggleSearch() { 
            const card = document.querySelector('.search-card');
            const fab = document.getElementById('fabSearch');
            if(card.classList.contains('active')) {
                card.classList.remove('active');
                fab.style.display = 'flex'; 
            } else {
                card.classList.add('active');
                fab.style.display = 'none'; 
                document.getElementById('resultsSheet').classList.remove('active');
            }
        }
        document.querySelector('.search-card').classList.add('active');

        function fermerResultats() { 
            document.getElementById('resultsSheet').classList.remove('active');
            setTimeout(() => { document.querySelector('.search-card').classList.add('active'); }, 300);
        }

        // --- 5. MARQUEURS ---
        const iconBus = L.divIcon({
            className: 'modern-bus-icon',
            html: '<i class="fas fa-bus"></i>',
            iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -25]
        });

        const iconUser = L.divIcon({
            className: 'custom-div-icon',
            html: `<div class="pulse-ring"></div><div class="modern-user-icon" style="width:24px; height:24px;"></div>`,
            iconSize: [24, 24], iconAnchor: [12, 12]
        });

        const iconStation = L.divIcon({ className: 'station-icon', html: '', iconSize: [12, 12], iconAnchor: [6, 6] });

        // --- 6. FONCTIONS MÉTIER ---
        function loadFavorites() {
            const favs = JSON.parse(localStorage.getItem('tizi_favs') || '[]');
            const container = document.getElementById('favContainer');
            container.innerHTML = '';
            favs.forEach((fav, index) => {
                const chip = document.createElement('div');
                chip.className = 'fav-chip';
                chip.innerHTML = `<i class="fas fa-heart" style="color:var(--danger)"></i> ${fav.arr}`; 
                chip.onclick = () => { document.getElementById('txtDepart').value = fav.dep; document.getElementById('txtArrivee').value = fav.arr; lancerRecherche(); };
                chip.oncontextmenu = (e) => { e.preventDefault(); if(confirm("Supprimer ce favori ?")) { favs.splice(index, 1); localStorage.setItem('tizi_favs', JSON.stringify(favs)); loadFavorites(); } };
                container.appendChild(chip);
            });
        }

        function saveFavorite() {
            const dep = document.getElementById('txtDepart').value; const arr = document.getElementById('txtArrivee').value;
            if(!dep || !arr) return alert("Remplissez le trajet d'abord !");
            const favs = JSON.parse(localStorage.getItem('tizi_favs') || '[]');
            favs.push({ dep, arr });
            localStorage.setItem('tizi_favs', JSON.stringify(favs));
            const btn = document.querySelector('.btn-fav-save'); btn.classList.add('saved'); setTimeout(() => btn.classList.remove('saved'), 1000);
            loadFavorites();
        }
        loadFavorites(); 

        function shareBus(busId, chauffeurNom) {
            const url = `${window.location.origin}${window.location.pathname}?bus=${busId}`;
            if (navigator.share) { navigator.share({ title: 'Suivre ce Shuttl', text: `Suis le bus de ${chauffeurNom} !`, url: url }).catch(console.error); }
            else { navigator.clipboard.writeText(url); alert("Lien copié !"); }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const sharedBusId = urlParams.get('bus');
        if(sharedBusId) { rechercheActive = true; document.querySelector('.search-card').classList.remove('active'); document.getElementById('fabSearch').style.display = 'flex'; }

        // --- 7. GEOLOCALISATION ---
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                userLat = pos.coords.latitude; userLon = pos.coords.longitude;
                userSpeed = pos.coords.speed || 0;
                
                let speedKmH = userSpeed * 3.6;
                if (speedKmH > 15) { isTraveling = true; } else { isTraveling = false; }

                if(!userMarker) { userMarker = L.marker([userLat, userLon], {icon: iconUser}).addTo(map); map.setView([userLat, userLon], 14); }
                else { userMarker.setLatLng([userLat, userLon]); }
                if(rechercheActive) fetchBus();
            }, err => console.log(err), { enableHighAccuracy: true });
        }

        function setupAutocomplete(inputId, listId) {
            const input = document.getElementById(inputId); const list = document.getElementById(listId); let timeout = null;
            input.addEventListener('input', function() {
                const query = this.value; if(timeout) clearTimeout(timeout); if(query.length < 2) { list.classList.remove('active'); return; }
                timeout = setTimeout(async () => {
                    try {
                        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=dz&addressdetails=1&limit=5`;
                        const res = await fetch(url); const data = await res.json();
                        list.innerHTML = '';
                        if(data.length > 0) {
                            list.classList.add('active');
                            data.forEach(item => {
                                const name = item.name; const details = item.address.state || "Algérie";
                                const div = document.createElement('div'); div.className = 'suggestion-item';
                                div.innerHTML = `<strong>${name}</strong> <span style="font-size:0.8rem;">(${details})</span>`;
                                div.onclick = () => { input.value = name; list.classList.remove('active'); };
                                list.appendChild(div);
                            });
                        } else { list.
