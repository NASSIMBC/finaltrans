<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <title>Tizi Transport</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.95);
            --accent: #3b82f6; /* NOUVEAU : Bleu Électrique */
            --accent-glow: rgba(59, 130, 246, 0.5);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --border: rgba(255,255,255,0.1);
            --map-tiles: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
        }

        [data-theme="light"] {
            --bg-dark: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.95);
            --accent: #2563eb;
            --accent-glow: rgba(37, 99, 235, 0.3);
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: rgba(0,0,0,0.1);
            --map-tiles: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        }

        body { margin: 0; font-family: 'Urbanist', sans-serif; background: black; overflow: hidden; }
        
        #map { height: 100vh; width: 100%; z-index: 1; }
        .leaflet-control-attribution { display: none; }

        /* --- NOUVEAUX STYLES D'ICÔNES --- */
        
        /* Icône BUS Moderne */
        .modern-bus-icon {
            background: linear-gradient(135deg, var(--accent), #1d4ed8);
            border-radius: 12px;
            color: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem;
            box-shadow: 0 0 15px var(--accent-glow);
            border: 2px solid white;
            transition: transform 0.3s;
        }
        
        /* Icône USER Moderne (avec pulsation) */
        .modern-user-icon {
            background: #10b981; /* Vert Menthe */
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .pulse-ring {
            border: 3px solid #10b981;
            border-radius: 50%;
            height: 40px; width: 40px;
            position: absolute; left: -8px; top: -8px;
            animation: pulsate 2s ease-out;
            animation-iteration-count: infinite; 
            opacity: 0.0;
        }
        @keyframes pulsate {
            0% {transform: scale(0.1, 0.1); opacity: 0.0;}
            50% {opacity: 1.0;}
            100% {transform: scale(1.2, 1.2); opacity: 0.0;}
        }

        /* Icône ARRÊT DE BUS */
        .station-icon {
            background: white; border: 3px solid #64748b;
            border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* --- UI EXISTANTE --- */
        .top-bar { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; pointer-events: none; }
        .profile-chip { pointer-events: auto; background: var(--card-bg); backdrop-filter: blur(10px); padding: 8px 16px 8px 8px; border-radius: 50px; display: flex; align-items: center; gap: 10px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .profile-img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--accent); }
        .profile-text { font-size: 0.9rem; color: var(--text-main); font-weight: 700; }
        
        .top-right-group { display: flex; gap: 10px; pointer-events: auto; }
        .round-btn { width: 45px; height: 45px; background: var(--card-bg); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid var(--border); cursor: pointer; color: var(--text-main); backdrop-filter: blur(10px); transition: 0.3s; }
        .round-btn:active { transform: scale(0.9); }

        .search-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 2000; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .search-overlay.active { transform: translateY(0); }
        .search-card { background: var(--card-bg); padding: 25px; border-radius: 25px; border: 1px solid var(--border); width: 100%; max-width: 400px; margin: 50px auto 0 auto; box-sizing: border-box; }
        .card-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 20px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }
        .btn-close { background: none; border: none; color: var(--text-main); font-size: 1.5rem; cursor: pointer; }

        .route-visual { display: flex; gap: 15px; }
        .dots-col { display: flex; flex-direction: column; align-items: center; padding-top: 15px; }
        .dot-start { width: 12px; height: 12px; background: var(--accent); border-radius: 50%; }
        .line { width: 2px; height: 50px; background: var(--text-muted); opacity: 0.3; margin: 5px 0; }
        .dot-end { width: 12px; height: 12px; border: 2px solid #ef4444; border-radius: 50%; }
        
        .inputs-col { flex: 1; display: flex; flex-direction: column; gap: 15px; position: relative; } 
        .input-field { width: 100%; padding: 16px; border-radius: 12px; border: none; background: rgba(0,0,0,0.2); color: var(--text-main); font-weight: 600; border: 1px solid var(--border); font-family: 'Urbanist', sans-serif; outline: none; box-sizing: border-box; }
        [data-theme="light"] .input-field { background: #f8fafc; border: 1px solid #cbd5e1; }

        .suggestions-list {
            position: absolute; left: 0; right: 0; z-index: 100;
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 12px; max-height: 200px; overflow-y: auto;
            margin-top: 5px; display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .suggestions-list.active { display: block; }
        .suggestion-item { padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 0.9rem; color: var(--text-muted); transition: 0.2s; }
        .suggestion-item:hover { background: rgba(59, 130, 246, 0.1); color: var(--accent); }
        .suggestion-item strong { color: var(--text-main); }

        .options-row { display: flex; gap: 10px; margin-top: 20px; }
        .visibility-toggle {
            flex: 1; display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 12px; 
            cursor: pointer; border: 1px solid transparent; transition: 0.3s;
        }
        [data-theme="light"] .visibility-toggle { background: #e2e8f0; }
        .visibility-toggle.active { border-color: var(--accent); background: rgba(59, 130, 246, 0.1); }
        .vis-icon { color: var(--text-muted); }
        .visibility-toggle.active .vis-icon { color: var(--accent); }
        
        .btn-fav-save {
            width: 50px; display: flex; justify-content: center; align-items: center;
            background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid transparent; cursor: pointer;
        }
        [data-theme="light"] .btn-fav-save { background: #e2e8f0; }
        .btn-fav-save.saved { color: #ef4444; border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }

        .btn-main { width: 100%; padding: 16px; border-radius: 12px; border: none; background: var(--accent); color: white; font-size: 1rem; font-weight: 800; cursor: pointer; margin-top: 25px; }

        .favorites-bar { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-top: 20px; }
        .fav-chip {
            background: var(--card-bg); border: 1px solid var(--border); padding: 8px 12px;
            border-radius: 20px; font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
        }
        .fav-chip i { color: #ef4444; font-size: 0.7rem; }

        .bottom-sheet { position: absolute; bottom: 20px; left: 15px; right: 15px; background: var(--card-bg); backdrop-filter: blur(20px); border-radius: 24px; padding: 0 20px 20px 20px; z-index: 1500; border: 1px solid var(--border); transform: translateY(150%); transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1); max-height: 50vh; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-header { position: sticky; top: 0; background: inherit; z-index: 10; padding-top: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .drag-handle { width: 40px; height: 4px; background: var(--text-muted); opacity:0.3; border-radius: 10px; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); }
        .sheet-title { font-weight: 800; color: var(--text-muted); font-size: 0.8rem; letter-spacing: 1px; }
        .btn-close-sheet { background: rgba(255,255,255,0.1); border: none; color: var(--text-main); width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        [data-theme="light"] .btn-close-sheet { background: #e2e8f0; }

        .bus-item { display: flex; align-items: center; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 16px; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        [data-theme="light"] .bus-item { background: #f8fafc; border: 1px solid #e2e8f0; }
        .bus-item:active { border-color: var(--accent); }
        .bus-info { flex: 1; margin-left: 15px; }
        .bus-name { color: var(--text-main); font-weight: 800; font-size: 1rem; }
        .bus-meta { color: var(--accent); font-size: 0.85rem; font-weight: 600; }
        .bus-matricule { background: rgba(59, 130, 246, 0.15); padding: 2px 6px; border-radius: 4px; color: var(--accent); font-size: 0.75rem; margin-left: 5px; }
        .bus-distance { color: var(--text-main); font-weight: 700; }
        
        .btn-share { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.1rem; margin-left: 10px; z-index: 5; }
        .btn-share:hover { color: var(--accent); }
    </style>
</head>
<body>

    <script>if(!localStorage.getItem('user_session')) window.location.href = '/connexion';</script>

    <div class="top-bar">
        <div class="profile-chip">
            <img src="https://ui-avatars.com/api/?name=User&background=random" class="profile-img">
            <div class="profile-text" id="txtName">Voyageur</div>
        </div>
        <div class="top-right-group">
            <div class="round-btn" onclick="toggleTheme()">
                <i class="fas fa-moon" id="themeIcon"></i>
            </div>
            <div class="round-btn" onclick="toggleSearch()">
                <i class="fas fa-search"></i>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div class="search-overlay active" id="searchOverlay">
        <div class="search-card">
            <div class="card-title">
                Trajet
                <button class="btn-close" onclick="toggleSearch()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="route-visual">
                <div class="dots-col"><div class="dot-start"></div><div class="line"></div><div class="dot-end"></div></div>
                <div class="inputs-col">
                    <div style="position:relative;">
                        <input type="text" class="input-field" id="txtDepart" placeholder="D'où partez-vous ?">
                        <div id="listDepart" class="suggestions-list"></div>
                    </div>
                    <div style="position:relative;">
                        <input type="text" class="input-field" id="txtArrivee" placeholder="Où allez-vous ?">
                        <div id="listArrivee" class="suggestions-list"></div>
                    </div>
                </div>
            </div>

            <div class="options-row">
                <div class="visibility-toggle active" id="btnVisibilite" onclick="toggleVisibility()">
                    <div class="vis-icon"><i class="fas fa-eye" id="visIcon"></i></div>
                    <span style="font-size:0.8rem; font-weight:600; color:var(--text-muted);" id="visText">Visible</span>
                    <i class="fas fa-toggle-on" id="visToggleIcon" style="color:var(--accent);"></i>
                </div>
                <div class="btn-fav-save" onclick="saveFavorite()">
                    <i class="fas fa-heart"></i>
                </div>
            </div>

            <button class="btn-main" onclick="lancerRecherche()">
                Trouver un chauffeur
            </button>

            <div class="favorites-bar" id="favContainer"></div>
        </div>
    </div>

    <div class="bottom-sheet" id="resultsSheet">
        <div class="sheet-header">
            <div class="drag-handle"></div>
            <div class="sheet-title">RÉSULTATS</div>
            <button class="btn-close-sheet" onclick="fermerResultats()"><i class="fas fa-times"></i></button>
        </div>
        <div id="busList"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        const SERVER_URL = "https://finaltrans.onrender.com"; 
        let rechercheActive = false;
        let currentRouteLayer = null; 
        let isVisibleToDriver = true;
        let userLat, userLon, userMarker;
        let userSpeed = 0;
        let busMarkers = {};
        let map; 
        let tileLayer;

        const session = JSON.parse(localStorage.getItem('user_session'));
        if(session && session.user.nom_complet) document.getElementById('txtName').innerText = session.user.nom_complet.split(' ')[0];

        // --- INITIALISATION CARTE ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([36.72, 4.05], 13);
            const themeUrl = getComputedStyle(document.documentElement).getPropertyValue('--map-tiles').trim().replace(/'/g, "");
            tileLayer = L.tileLayer(themeUrl).addTo(map);
        }
        initMap();

        // --- NOUVELLES ICÔNES MODERNES ---
        // Icône Bus CSS (Bleu/Dégradé)
        const iconBus = L.divIcon({
            className: 'modern-bus-icon',
            html: '<i class="fas fa-bus"></i>',
            iconSize: [36, 36],
            iconAnchor: [18, 18],
            popupAnchor: [0, -20]
        });

        // Icône User CSS (Vert/Pulse)
        const iconUser = L.divIcon({
            className: 'custom-div-icon',
            html: `<div class="pulse-ring"></div><div class="modern-user-icon" style="width:24px; height:24px;"></div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        // Icône Arrêt
        const iconStation = L.divIcon({ 
            className: 'station-icon', 
            html: '', 
            iconSize: [12, 12], 
            iconAnchor: [6, 6] 
        });

        // --- GESTION THÈME (JOUR / NUIT) ---
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const icon = document.getElementById('themeIcon');
            
            if (current === 'dark') {
                html.setAttribute('data-theme', 'light');
                icon.className = "fas fa-sun";
                tileLayer.setUrl('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
            } else {
                html.setAttribute('data-theme', 'dark');
                icon.className = "fas fa-moon";
                tileLayer.setUrl('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
            }
        }

        // --- GESTION FAVORIS ---
        function loadFavorites() {
            const favs = JSON.parse(localStorage.getItem('tizi_favs') || '[]');
            const container = document.getElementById('favContainer');
            container.innerHTML = '';
            
            favs.forEach((fav, index) => {
                const chip = document.createElement('div');
                chip.className = 'fav-chip';
                chip.innerHTML = `<i class="fas fa-heart"></i> ${fav.arr}`; 
                chip.onclick = () => {
                    document.getElementById('txtDepart').value = fav.dep;
                    document.getElementById('txtArrivee').value = fav.arr;
                    lancerRecherche();
                };
                chip.oncontextmenu = (e) => {
                    e.preventDefault();
                    if(confirm("Supprimer ce favori ?")) {
                        favs.splice(index, 1);
                        localStorage.setItem('tizi_favs', JSON.stringify(favs));
                        loadFavorites();
                    }
                };
                container.appendChild(chip);
            });
        }

        function saveFavorite() {
            const dep = document.getElementById('txtDepart').value;
            const arr = document.getElementById('txtArrivee').value;
            if(!dep || !arr) return alert("Remplissez le trajet d'abord !");
            
            const favs = JSON.parse(localStorage.getItem('tizi_favs') || '[]');
            favs.push({ dep, arr });
            localStorage.setItem('tizi_favs', JSON.stringify(favs));
            
            const btn = document.querySelector('.btn-fav-save');
            btn.classList.add('saved');
            setTimeout(() => btn.classList.remove('saved'), 1000);
            
            loadFavorites();
        }
        loadFavorites(); 

        // --- PARTAGE DE LIEN ---
        function shareBus(busId, chauffeurNom) {
            const url = `${window.location.origin}${window.location.pathname}?bus=${busId}`;
            if (navigator.share) {
                navigator.share({
                    title: 'Suivre ce bus - Tizi Transport',
                    text: `Suis le bus de ${chauffeurNom} en temps réel !`,
                    url: url
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(url);
                alert("Lien copié dans le presse-papier !");
            }
        }

        // Vérification lien partagé
        const urlParams = new URLSearchParams(window.location.search);
        const sharedBusId = urlParams.get('bus');
        if(sharedBusId) {
            rechercheActive = true;
            document.getElementById('searchOverlay').classList.remove('active');
        }

        // GPS USER
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                userSpeed = pos.coords.speed || 0;
                
                if(!userMarker) {
                    userMarker = L.marker([userLat, userLon], {icon: iconUser}).addTo(map);
                    map.setView([userLat, userLon], 14);
                } else {
                    userMarker.setLatLng([userLat, userLon]);
                }
                if(rechercheActive) fetchBus();
            }, err => console.log(err), { enableHighAccuracy: true });
        }

        // AUTOCOMPLETION
        function setupAutocomplete(inputId, listId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            let timeout = null;

            input.addEventListener('input', function() {
                const query = this.value;
                if(timeout) clearTimeout(timeout);
                if(query.length < 2) { list.classList.remove('active'); return; }

                timeout = setTimeout(async () => {
                    try {
                        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=dz&addressdetails=1&limit=5`;
                        const res = await fetch(url);
                        const data = await res.json();
                        list.innerHTML = '';
                        if(data.length > 0) {
                            list.classList.add('active');
                            data.forEach(item => {
                                const name = item.name;
                                const details = item.address.state || "Algérie";
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.innerHTML = `<strong>${name}</strong> <span style="font-size:0.8rem;">(${details})</span>`;
                                div.onclick = () => { input.value = name; list.classList.remove('active'); };
                                list.appendChild(div);
                            });
                        } else { list.classList.remove('active'); }
                    } catch(e) {}
                }, 300);
            });
            document.addEventListener('click', (e) => { if(e.target !== input && e.target !== list) list.classList.remove('active'); });
        }
        setupAutocomplete('txtDepart', 'listDepart');
        setupAutocomplete('txtArrivee', 'listArrivee');

        function toggleVisibility() {
            isVisibleToDriver = !isVisibleToDriver;
            const toggle = document.getElementById('visToggleIcon');
            const text = document.getElementById('visText');
            document.getElementById('btnVisibilite').classList.toggle('active');
            
            if(isVisibleToDriver) {
                toggle.className = "fas fa-toggle-on"; toggle.style.color = "var(--accent)"; text.innerText = "Visible";
            } else {
                toggle.className = "fas fa-toggle-off"; toggle.style.color = "#64748b"; text.innerText = "Invisible";
            }
        }

        function toggleSearch() { document.getElementById('searchOverlay').classList.toggle('active'); }
        function fermerResultats() { document.getElementById('resultsSheet').classList.remove('active'); }

        function lancerRecherche() {
            const dep = document.getElementById('txtDepart').value;
            const arr = document.getElementById('txtArrivee').value;
            if (currentRouteLayer) { map.removeLayer(currentRouteLayer); currentRouteLayer = null; }
            document.querySelectorAll('.leaflet-marker-icon .terminus-flag').forEach(el => el.parentElement.remove());

            if(!dep && !arr) return alert("Remplissez au moins une ville !");

            rechercheActive = true;
            document.getElementById('searchOverlay').classList.remove('active');
            document.getElementById('resultsSheet').classList.add('active');
            document.getElementById('busList').innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">Recherche...</div>';
            fetchBus();
        }

        async function afficherTrajet(bus) {
            if (!bus.terminus_officiel) return;
            if (currentRouteLayer) { map.removeLayer(currentRouteLayer); currentRouteLayer = null; }
            const start = `${bus.current_lon},${bus.current_lat}`;
            const end = `${bus.terminus_officiel.lon},${bus.terminus_officiel.lat}`;
            const url = `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=full&geometries=geojson`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.routes && data.routes.length > 0) {
                    currentRouteLayer = L.geoJSON(data.routes[0].geometry, { style: { color: "#3b82f6", weight: 6, opacity: 0.8 } }).addTo(map);
                    map.fitBounds(currentRouteLayer.getBounds(), { padding: [50, 50] });
                }
            } catch (e) { console.error("Erreur trajet:", e); }
        }

        async function fetchBus() {
            if(!rechercheActive && !sharedBusId) return; 
            
            const container = document.getElementById('busList');
            const dep = document.getElementById('txtDepart').value;
            const arr = document.getElementById('txtArrivee').value;

            let speedKmH = (userSpeed || 0) * 3.6;
            let effectiveVisibility = isVisibleToDriver;
            if (speedKmH > 15) effectiveVisibility = false;

            try {
                const res = await fetch(SERVER_URL + '/api/trouver-bus', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_lat: userLat, user_lon: userLon, depart_text: dep, arrivee_text: arr, visible: effectiveVisibility })
                });
                const data = await res.json();
                
                container.innerHTML = '';
                for(let id in busMarkers) map.removeLayer(busMarkers[id]);
                busMarkers = {};

                if(data.bus_proches && data.bus_proches.length > 0) {
                    data.bus_proches.forEach(bus => {
                        const m = L.marker([bus.current_lat, bus.current_lon], {icon: iconBus}).addTo(map);
                        m.bindPopup(`
                            <div style="text-align:center; color:black; font-family:'Urbanist',sans-serif;">
                                <div style="background:var(--accent); color:white; font-weight:800; padding:5px; border-radius:8px; margin-bottom:5px;">~ ${bus.eta || '?'} min</div>
                                <strong>${bus.chauffeur}</strong><br>
                                <span style="font-size:0.8rem;">${bus.modele}</span><br>
                                <span style="background:#facc15; padding:2px; font-weight:bold;">${bus.matricule}</span>
                            </div>
                        `);
                        m.on('click', () => { afficherTrajet(bus); });
                        busMarkers[bus.bus_id] = m;

                        if(sharedBusId && bus.bus_id === sharedBusId) {
                            map.setView([bus.current_lat, bus.current_lon], 16);
                            m.openPopup();
                            afficherTrajet(bus);
                        }

                        const div = document.createElement('div');
                        div.className = 'bus-item';
                        div.innerHTML = `
                            <div style="background:#333; width:40px; height:40px; border-radius:10px; display:flex; justify-content:center; align-items:center;">
                                <i class="fas fa-bus" style="color:white;"></i>
                            </div>
                            <div class="bus-info">
                                <div class="bus-name">${bus.chauffeur}</div>
                                <div class="bus-meta">${bus.modele}</div>
                                <div class="bus-sub" style="color:var(--accent); font-weight:bold;">
                                    <i class="fas fa-clock"></i> ${bus.eta || '?'} min <span style="color:var(--text-muted); font-weight:normal;">(${bus.distance_km} km)</span>
                                </div>
                            </div>
                            <button class="btn-share" onclick="event.stopPropagation(); shareBus('${bus.bus_id}', '${bus.chauffeur}')">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        `;
                        div.onclick = () => { afficherTrajet(bus); map.setView([bus.current_lat, bus.current_lon], 16); m.openPopup(); };
                        container.appendChild(div);
                    });
                } else { container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted);">Aucun bus trouvé.</div>'; }
            } catch(e) { console.error(e); }
        }

    let busStopsLayer = L.layerGroup().addTo(map); 

    async function chargerArretsOsm() {
        const bounds = map.getBounds();
        if(map.getZoom() < 14) { busStopsLayer.clearLayers(); return; }
        const south = bounds.getSouth(); const west = bounds.getWest(); const north = bounds.getNorth(); const east = bounds.getEast();
        const query = `[out:json][timeout:25];(node["highway"="bus_stop"](${south},${west},${north},${east});node["public_transport"="platform"](${south},${west},${north},${east}););out body;`;
        const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
        try {
            const res = await fetch(url); const data = await res.json();
            busStopsLayer.clearLayers();
            data.elements.forEach(element => {
                const nom = element.tags.name || "Arrêt"; 
                L.marker([element.lat, element.lon], {icon: iconStation}).bindPopup(`<b style="color:black">${nom}</b>`).addTo(busStopsLayer);
            });
        } catch (e) { console.error("Erreur OSM:", e); }
    }
    map.on('moveend', chargerArretsOsm);
    setInterval(fetchBus, 5000);
    </script>
</body>
</html>
