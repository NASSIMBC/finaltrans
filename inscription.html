<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscription Tizi Transport</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Urbanist', sans-serif; background: #000000; color: white; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .card { background: #1e1e1e; padding: 25px; border-radius: 24px; width: 100%; max-width: 500px; border: 1px solid #333; }
        h3 { text-align: center; color: #d4fb79; margin-top: 0; }

        input { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #333; background: #2c2c2c; color: white; box-sizing: border-box; }
        
        /* Selecteur R√¥le */
        .switch { display: flex; margin-bottom: 20px; background: #2c2c2c; padding: 5px; border-radius: 12px; }
        .switch div { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 10px; transition: 0.3s; font-weight: bold; }
        .active { background: #d4fb79; color: black; }

        /* Carte de s√©lection */
        #mapSelection { height: 300px; width: 100%; border-radius: 15px; margin-bottom: 15px; border: 2px solid #333; display: none; }
        
        .map-controls { display: flex; gap: 10px; margin-bottom: 10px; display: none; }
        .btn-map { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; opacity: 0.6; }
        .btn-map.selected { opacity: 1; border: 2px solid white; }
        .btn-dep { background: #d4fb79; color: black; } /* Vert/Jaune */
        .btn-arr { background: #ef4444; color: white; } /* Rouge */

        button.main-btn { width: 100%; padding: 16px; background: white; color: black; border: none; border-radius: 12px; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 15px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <h3>Cr√©er un compte</h3>
    
    <div class="switch">
        <div id="btnV" class="active" onclick="setRole('voyageur')">Voyageur</div>
        <div id="btnC" onclick="setRole('chauffeur')">Chauffeur</div>
    </div>

    <input type="text" id="nom" placeholder="Nom complet">
    <input type="tel" id="tel" placeholder="T√©l√©phone">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Mot de passe">

    <div id="driverFields" class="hidden">
        <p style="font-size:0.9rem; color:#aaa; margin-bottom:10px;">Configurez votre ligne sur la carte :</p>
        
        <div class="map-controls" id="mapControls">
            <button class="btn-map btn-dep selected" id="btnSelectDep" onclick="setMode('depart')">üìç Point D√©part</button>
            <button class="btn-map btn-arr" id="btnSelectArr" onclick="setMode('arrivee')">üèÅ Terminus</button>
        </div>

        <div id="mapSelection"></div>

        <input type="text" id="v_depart" placeholder="Ville de D√©part (Auto)" readonly style="background:#111; color:#d4fb79;">
        <input type="text" id="v_arrivee" placeholder="Ville d'Arriv√©e (Auto)" readonly style="background:#111; color:#ef4444;">
        
        <input type="hidden" id="dep_lat"><input type="hidden" id="dep_lon">
        <input type="hidden" id="arr_lat"><input type="hidden" id="arr_lon">

        <input type="text" id="matricule" placeholder="Matricule (ex: 00123-116-15)">
        <input type="text" id="modele" placeholder="Mod√®le (ex: Toyota Coaster)">
    </div>

    <button class="main-btn" onclick="inscrire()">S'inscrire</button>
    <p style="text-align:center; margin-top:15px; font-size:0.9rem;"><a href="/connexion" style="color:#d4fb79;">Se connecter</a></p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let role = 'voyageur';
    let map, markerDep, markerArr;
    let modeSelection = 'depart'; // 'depart' ou 'arrivee'

    function setRole(r) {
        role = r;
        document.getElementById('btnV').className = r === 'voyageur' ? 'active' : '';
        document.getElementById('btnC').className = r === 'chauffeur' ? 'active' : '';
        
        const driverDiv = document.getElementById('driverFields');
        const mapDiv = document.getElementById('mapSelection');
        const controls = document.getElementById('mapControls');

        if(r === 'chauffeur') {
            driverDiv.style.display = 'block';
            mapDiv.style.display = 'block';
            controls.style.display = 'flex';
            initMap();
        } else {
            driverDiv.style.display = 'none';
        }
    }

    function initMap() {
        if(map) return; // D√©j√† initialis√©e
        map = L.map('mapSelection').setView([36.72, 4.05], 10); // Centr√© sur Tizi/Kabylie
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        map.on('click', async function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;

            // Appel API pour trouver le nom de la ville (Reverse Geocoding)
            const villeNom = await getCityName(lat, lon);

            if(modeSelection === 'depart') {
                if(markerDep) map.removeLayer(markerDep);
                markerDep = L.marker([lat, lon], {icon: createIcon('green')}).addTo(map);
                
                document.getElementById('v_depart').value = villeNom;
                document.getElementById('dep_lat').value = lat;
                document.getElementById('dep_lon').value = lon;
                
                // Passe automatiquement √† l'√©tape suivante
                setMode('arrivee');
            } else {
                if(markerArr) map.removeLayer(markerArr);
                markerArr = L.marker([lat, lon], {icon: createIcon('red')}).addTo(map);
                
                document.getElementById('v_arrivee').value = villeNom;
                document.getElementById('arr_lat').value = lat;
                document.getElementById('arr_lon').value = lon;
            }
        });
    }

    function setMode(m) {
        modeSelection = m;
        document.getElementById('btnSelectDep').className = m === 'depart' ? 'btn-map btn-dep selected' : 'btn-map btn-dep';
        document.getElementById('btnSelectArr').className = m === 'arrivee' ? 'btn-map btn-arr selected' : 'btn-map btn-arr';
    }

    function createIcon(color) {
        const url = color === 'green' 
            ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png'
            : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
        return L.icon({ iconUrl: url, iconSize: [25, 41], iconAnchor: [12, 41] });
    }

    // Utilisation de Nominatim (OpenStreetMap) pour trouver le nom
    async function getCityName(lat, lon) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await res.json();
            // On cherche le meilleur nom possible (Ville, Village, ou Quartier)
            return data.address.city || data.address.town || data.address.village || data.address.county || "Position Inconnue";
        } catch(e) {
            return "Position GPS";
        }
    }

    async function inscrire() {
        const data = {
            role: role,
            nom: document.getElementById('nom').value,
            tel: document.getElementById('tel').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            
            // Donn√©es Chauffeur
            v_depart: document.getElementById('v_depart').value,
            v_arrivee: document.getElementById('v_arrivee').value,
            matricule: document.getElementById('matricule').value,
            modele: document.getElementById('modele').value,
            
            // COORDONN√âES EXACTES
            dep_lat: document.getElementById('dep_lat').value,
            dep_lon: document.getElementById('dep_lon').value,
            arr_lat: document.getElementById('arr_lat').value,
            arr_lon: document.getElementById('arr_lon').value
        };

        const res = await fetch('/api/register', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if(res.ok) {
            alert("Compte cr√©√© !");
            window.location.href = '/connexion';
        } else {
            alert("Erreur inscription");
        }
    }
</script>
</body>
</html>
